---
title: "AWS ECS + CodeDeploy + CodePipeline ( + ã¡ã‚‡ã£ã¨Terraform )  â€“ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’ ãƒ­ãƒ¼ãƒª"
emoji: "ğŸ–¥"
type: "idea"
topics: ["AWS", "Terraform", "ECS"]
published: true
---

ECSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‹ã‚‰blue/greenã«å¤‰ãˆã‚‹æ‰‹é †ã‚’è¨˜ã™

# äº‹å‰ç¢ºèª

ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¨blue/greenãƒ‡ãƒ—ãƒ­ã‚¤ã®ã©ã¡ã‚‰ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã®ç¢ºèª

- ECSã¸ã®ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
- CodeBuildã‚’åˆ©ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã¯blue/greenãƒ‡ãƒ—ãƒ­ã‚¤

ä¸»ã«ã“ã®æ§‹æˆã®ã‚ˆã†ã ã€‚(2023/08/18ç¾åœ¨)

ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«CodeDeployã®å±¥æ­´ã«ä½•ã‚‚å¢—ãˆãªã‘ã‚Œã°æã‚‰ãECSã¸ã®ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã•ã‚Œã¦ã‚‹ã¯ãšã€‚


# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹

ç‰¹ã«blueç”¨ã¨greenç”¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹ã¨ã„ã†ã‚ã‘ã§ã¯ãªã
blue/greenãƒ‡ãƒ—ãƒ­ã‚¤ã§ã¯2å€‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°ã•ã‚Œã‚‹

- ALBã®ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã«ç´ã¥ãã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒæ›´æ–°ã•ã‚Œã‚‹
- ECSã«ç´ã¥ãã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒæ›´æ–°ã•ã‚Œã‚‹

ã¨ã„ã†å‹•ä½œã®ã‚ˆã†ã ã€‚

ãªã®ã§æ—¢ã«ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ã‚‹å ´åˆã¯åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒ1å€‹ã¯ã‚ã‚‹ã¯ãšãªã®ã§ã€ãã‚Œã¨åŒã˜ã‚ˆã†ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚‚ã†1å€‹ä½œã‚Œã°è‰¯ã„ã€‚

2å€‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã¯åŒã˜ALBã«ç´ã¥ãã‚ˆã†ã«ã—ã¦ãŠãã€‚


# ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ

AWSCodeDeployRoleForECS ã®ã‚»ãƒƒãƒˆ(ï¼Ÿ)ã§ãƒ­ãƒ¼ãƒ«ã‚’ä½œã£ã¦ãŠã‘ã°è‰¯ã„ã‚ˆã†ã 

<img width="1069" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/5220c58a-635e-4e56-88b1-f5696f0cb590">

JSONã‚’è¦‹ã¦ã¿ã‚‹ã¨æ¬¡ã®é€šã‚Š

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "ecs:DescribeServices",
                "ecs:CreateTaskSet",
                "ecs:UpdateServicePrimaryTaskSet",
                "ecs:DeleteTaskSet",
                "elasticloadbalancing:DescribeTargetGroups",
                "elasticloadbalancing:DescribeListeners",
                "elasticloadbalancing:ModifyListener",
                "elasticloadbalancing:DescribeRules",
                "elasticloadbalancing:ModifyRule",
                "lambda:InvokeFunction",
                "cloudwatch:DescribeAlarms",
                "sns:Publish",
                "s3:GetObject",
                "s3:GetObjectVersion"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "iam:PassRole"
            ],
            "Effect": "Allow",
            "Resource": "*",
            "Condition": {
                "StringLike": {
                    "iam:PassedToService": [
                        "ecs-tasks.amazonaws.com"
                    ]
                }
            }
        }
    ]
}
```

# CodeDeployã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹

ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒ— : Amazon ECS

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹

## Web Console ã®å ´åˆ

- ECSã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚„ã‚µãƒ¼ãƒ“ã‚¹
- ECSã§åˆ©ç”¨ã—ã¦ã„ã‚‹ALB
- 2å€‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—

ãªã©ã‚’æŒ‡å®šã—ã¦ã„ã

ã“ã®
ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¯äº‹å‰ã«ä½œã£ã¦ãŠã‘ã°é¸æŠè‚¢ã«å‡ºã¦ãã‚‹

<img width="877" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/c274608a-2bdb-4f0b-bc6a-7753fe6809b5">


ãƒãƒ¼ãƒˆã®æŒ‡å®šã¯æœ¬ç•ªç¨¼åƒç”¨ã¨ãƒ†ã‚¹ãƒˆç”¨ã§åˆ¥ã®ã‚‚ã®ã‚’é¸ã¶
ALBã®ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã«å°‘ãªãã¨ã‚‚2ç¨®é¡ã®ãƒãƒ¼ãƒˆã®ãƒ«ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°ã„ã‘ãªã„ã‹ã‚‚ã—ã‚Œãªã„

## Terraformã®å ´åˆ

ã‚µãƒ³ãƒ—ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«çµ„ã¿ç«‹ã¦ã‚‹

https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codedeploy_deployment_group.html

```tf
resource "aws_codedeploy_app" "example" {
  compute_platform = "ECS"
  name             = "example"
}

resource "aws_codedeploy_deployment_group" "example" {
  app_name               = aws_codedeploy_app.example.name
  deployment_config_name = "CodeDeployDefault.ECSAllAtOnce"
  deployment_group_name  = "example"
  service_role_arn       = aws_iam_role.example.arn

  auto_rollback_configuration {
    enabled = true
    events  = ["DEPLOYMENT_FAILURE"]
  }

  blue_green_deployment_config {
    deployment_ready_option {
      action_on_timeout = "CONTINUE_DEPLOYMENT"
    }

    terminate_blue_instances_on_deployment_success {
      action                           = "TERMINATE"
      termination_wait_time_in_minutes = 5
    }
  }

  deployment_style {
    deployment_option = "WITH_TRAFFIC_CONTROL"
    deployment_type   = "BLUE_GREEN"
  }

  ecs_service {
    cluster_name = aws_ecs_cluster.example.name
    service_name = aws_ecs_service.example.name
  }

  load_balancer_info {
    target_group_pair_info {
      prod_traffic_route {
        listener_arns = [aws_lb_listener.example.arn]
      }

      target_group {
        name = aws_lb_target_group.blue.name
      }

      target_group {
        name = aws_lb_target_group.green.name
      }
    }
  }
}
```

# ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

AWSã«æœ€åˆã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã®ã²ãªãŒãŸãŒæ•°ç¨®é¡ã‚ã‚‹ã®ã§ç‰¹ã«è‡ªåˆ†ã§ã¯è¨­å®šã—ãªãã¦OK

# ECSã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—ã‚’å¤‰ãˆã‚‹

## WebConsoleã®å ´åˆ

å˜ã«è¨­å®šã‚’å¤‰ãˆã‚‹ã¨ã„ã†ã“ã¨ã¯å‡ºæ¥ãªã•ãã†ã€‚
ECSã‚µãƒ¼ãƒ“ã‚¹ä½œæˆæ™‚ã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—ã§ãƒ–ãƒ«ãƒ¼/ã‚°ãƒªãƒ¼ãƒ³ãŒé¸ã¹ã‚‹ã®ã§ã„ã¡ã©ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†åº¦ä½œæˆã™ã‚‹ã®ãŒè‰¯ã•ãã†ã€‚
(ã¡ãªã¿ã«æ–°ã—ã„UIã ã¨ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã‹é¸ã¹ãªããªã£ã¦ã„ã‚‹ã‚ˆã†ã )

## Terraformã®å ´åˆ

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—ã‚’å¤‰ãˆã¦ terraform apply ã‚’ã™ã‚‹ã¨ECSã‚µãƒ¼ãƒ“ã‚¹ãŒç ´æ£„ãƒ»å†ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ãªã®ã§æ³¨æ„

blue/greenãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã¯ECSã‚µãƒ¼ãƒ“ã‚¹ã«ç´ã¥ãã‚¿ã‚¹ã‚¯å®šç¾©ã®æ›´æ–°ãŒå‡ºæ¥ãªããªã‚‹ã‚ˆã†ãªã®ã§ã‚¿ã‚¹ã‚¯å®šç¾©ã®å¤‰æ›´ã‚’ignoreã—ã¦ãŠã
ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚‚
(æœ¬å½“ã«ã“ã®å¯¾å‡¦ã§è‰¯ã„ã®ã‹ã¯èª¿ã¹ãã‚Œã¦ã„ãªã„ãŒ)

```tf
resource "aws_ecs_service" "default" {

  ...

  deployment_controller {
    type = "CODE_DEPLOY"
  }

  lifecycle {
    ignore_changes        = [task_definition, load_balancer]
  }
}

```

# CodePipelineã®Deployã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨­å®šã‚’å¤‰ãˆã‚‹

## Web Consoleã®å ´åˆ

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ Amazon ECS (ãƒ–ãƒ«ãƒ¼/ã‚°ãƒªãƒ¼ãƒ³)ã«å¤‰ãˆã‚‹
 ã‚ã¨ã¯ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãªã©ã‚’é¸ã‚“ã§è¡Œã

ä»Šå›ã®ä¾‹ã§ã¯ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§å…¥åŠ›ã«ã¯Buildã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’é¸ã‚“ã§ã„ã‚‹

<img width="1440" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/c3e452cb-506e-470c-937c-00b698d33b40">

## Terraformã®å ´åˆ

ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’Deployã®å…¥åŠ›ã¨ã™ã‚‹å ´åˆã¯æ¬¡ã®ã‚ˆã†ãªæ„Ÿã˜


```tf

  stage {
    name = "Deploy"

    action {
      ... ã„ã‚ã„ã‚çœç•¥ ...

      provider        = "CodeDeployToECS"
      input_artifacts = ["Build"]

      configuration = {
        ApplicationName = "deploy-app"
        DeploymentGroupName = "deploy-group"

        Image1ArtifactName = "Build"
        Image1ContainerName = "IMAGE1_NAME"
        TaskDefinitionTemplateArtifact = "Build"
        TaskDefinitionTemplatePath = "taskdef.json"
        AppSpecTemplateArtifact = "Build"
        AppSpecTemplatePath = "appspec.yml"
      }

    }
  }
```



# appspec.yml ã‚’è¿½åŠ ã™ã‚‹

ãƒ¬ãƒã‚¸ãƒˆãƒªã®ãƒˆãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« appspec.yml ã¾ãŸã¯ appspec.json ã‚’è¨­å®šã™ã‚‹

`<TASK_DEFINITION>` ã®éƒ¨åˆ†ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§CodeDeployãŒã‚¿ã‚¹ã‚¯å®šç¾©ã®ARNã«å¤‰ãˆã¦ãã‚Œã‚‹

ContainerName / ContainerPort ã¯æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å‚ç…§ã™ã‚‹ãªã‚Šã—ã¦ç¢ºèªã™ã‚Œã°OK

```
version: '0.0'
Resources:
  - TargetService:
      Type: AWS::ECS::Service
      Properties:
        TaskDefinition: <TASK_DEFINITION>
        LoadBalancerInfo:
          ContainerName: container-name
          ContainerPort: 80
```

ã¡ãªã¿ã«ãƒ•ã‚¡ã‚¤ãƒ«åã¯CodePipelineã®Deployã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨­å®šã§å¤‰æ›´å¯èƒ½

<img width="1047" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/d8173636-6174-40d4-a13f-3963a49be04d">


# taskdef.json ã‚’ä½œæˆã™ã‚‹

ãƒ¬ãƒã‚¸ãƒˆãƒªã®ãƒˆãƒƒãƒ—ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ãŠã

æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã® JSON ã‚’ã²ãªå½¢ã«ã—ã¦ä½œã‚‹ã®ãŒã‚„ã‚Šã‚„ã™ã„ã€‚
(AWS Web Console ã§ã‚‚ã‚¿ã‚¹ã‚¯å®šç¾©ç”»é¢ã‹ã‚‰JSONãŒå–ã‚Œã‚‹ã¯ãš)

ãŸã å‡ºåŠ›ã•ã‚ŒãŸJSONã¨å…¥åŠ›ã«ä½¿ã†JSONã¯ç•°ãªã‚‹ã®ã§ä¿®æ­£ã™ã‚‹

- registeredAt
- registeredBy
- requiresAttributes
- status
- revision

ã¨ã‹ã¯ä¸è¦ãªé …ç›®ã®ã‚ˆã†ã 

ã‚ã¨tagsé …ç›®ãŒã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚‹ã®ã§è‡ªåˆ†ãŒè©¦ã—ãŸæ™‚ã¯æ¶ˆã—ã¦ãŠã„ãŸ

image ã¯CodePipelineã§æŒ‡å®šã—ãŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«ã™ã‚‹

```json
{
    "containerDefinitions": [
        {
            "name": "container-name",
            "image": "<IMAGE1_NAME>",
```

ã¡ãªã¿ã«localãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã‚¿ã‚¹ã‚¯å®šç¾©ç™»éŒ²ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ä¸è¦é …ç›®ãŒã‚ã‚‹å ´åˆã¯æ•™ãˆã¦ãã‚Œã‚‹ã®ã§è©¦ã—ã¦ã‚‚è‰¯ã„

```
aws ecs register-task-definition --cli-input-json file://taskdef.json
```

## ã©ã†ã‚„ã£ã¦ã‚¿ã‚¹ã‚¯å®šç¾©ã®å€¤ã‚’å‹•çš„ã«å¤‰ãˆã‚‹ã®ã‹ï¼Ÿ

ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ä»¥å¤–ã¯å‹•çš„ã«å¤‰ã‚ã‚‰ãªãã†ã€‚
èª¿ã¹ã‚‹ã¨ buildã‚¹ãƒ†ãƒ¼ã‚¸ ( buildspec.yml ) ã§sedã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ãªã‚Šã—ã¦ç’°å¢ƒã«å¿œã˜ã¦ç„¡ç†ã‚„ã‚Šãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’å¤‰ãˆã¦ã—ã¾ã†æ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ã„ãŸã€‚

å‚è€ƒ:

ECS Fargateãƒ‡ãƒ—ãƒ­ã‚¤ç”¨CodePipelineã®taskdef.jsonã«å¤‰æ•°ã‚’æŒãŸã›ã‚‹æ–¹æ³•
https://qiita.com/neruneruo/items/a5313beb3074a1af4df2

ä»–ã«ã¯ç’°å¢ƒã”ã¨ã«taskdef.jsonã‚’ç”¨æ„ã—ã¦ãŠããªã©ã‚„ã‚Šæ–¹ã¯è‰²ã€…ã‚ã‚‹ã ã‚ã†ãŒ

# buildspec.yml ã‚’ä¿®æ­£ã™ã‚‹

- ECSç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã¯ `imagedefinitions.json` ã‚’ä½œæˆã—ã¦ãŸãŒã“ã‚Œã‚’ `imageDetail.json` ã«å¤‰ãˆã‚‹
- appspec ã‚’Deployã‚¹ãƒ†ãƒ¼ã‚¸ç”¨ã®å‡ºåŠ›ã«å«ã‚ã‚‹
- appspec ã‚’Deployã‚¹ãƒ†ãƒ¼ã‚¸ç”¨ã®å‡ºåŠ›ã«å«ã‚ã‚‹

```yml
  post_build:
    commands:
      ...
      - printf '{"Version":"1.0","ImageURI":"%s"}' $REPOSITORY_URI:$IMAGE_TAG > imageDetail.json
artifacts:
  files:
    - imageDetail.json
    - taskdef.json
    - appspec.yml
```


# ã„ã–å®Ÿè¡Œ

- ECSã‚µãƒ¼ãƒ“ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ã‚’è©¦ã™
- ã‚½ãƒ¼ã‚¹ãƒ¬ãƒã‚¸ãƒˆãƒª (Githubã¨ã‹) ã« push ã™ã‚‹

ãªã©ã—ã¦å‹•ä½œã‚’è©¦ã™


# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura

