---
title: "Rails â€“ å€¤ãŒé‡è¤‡ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰DBã«è¤‡åˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Rails"]
published: true
---

# å•é¡Œ

é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã£ãŸã¾ã¾ã ã¨ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’DBã«è¿½åŠ ã§ããªã„

```
Caused by:
Mysql2::Error: Duplicate entry '1-1' for key 'clients.index_clients_on_first_name_and_last_name'
```

# ä¾‹

- first_name / last_name ã®çµ„ã¿åˆã‚ã›ã§DBã«ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’æŒãŸã›ãŸã„
- first_name / last_name ãŒåŒã˜çµ„ã¿åˆã‚ã›ã®ãƒ¦ãƒ¼ã‚¶ã¯é‡è¤‡åˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ãŸã„ (1å€‹ã ã‘æ®‹ã—ãŸã„)

ã¨ã„ã†å ´åˆ

# ã‚³ãƒ¼ãƒ‰ã®ä¾‹

1å€‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹
up ã« ActiveRecord ã‚’ç›´æ¥æ›¸ã„ã¦ã—ã¾ã†


```rb
class RemoveDuplicateClients < ActiveRecord::Migration[7.0]
  def up
    dupulicated_clients = Client.group(:first_name, :last_name).count.filter do |_k, v|
      v >= 2
    end

    dupulicated_clients.each do |(first_name, last_name), _count|
      Client.where(first_name:, last_name:).order(:id).drop(1).each(&:destroy)
    end
  end
end
```

æ¬¡ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯æ™®é€šã«è¤‡åˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹

```rb
class AddUniquenessToClients < ActiveRecord::Migration[7.0]
  def change
    add_index :clients, %i[first_name last_name], unique: true
  end
end
```


# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura
ra

