---
title: "Ansible | Docker ã§ Ansible ã®å‹•ä½œç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["åˆå¿ƒè€…", "Docker", "Ansible"]
published: true
published_at: 2017-06-30t14:56
---

# Dockerå´ã®ç”¨æ„

## Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ

ã“ã®ä¾‹ã§ã¯ã€æ¬¡ã®æ¡ä»¶ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ã€‚

- pythonãŒä½¿ãˆã‚‹ ( Ansble ã®å®Ÿè¡Œç’°å¢ƒãŸã‚ )
- sshã§ç›´æ¥æ¥ç¶šãŒã§ãã‚‹
- ssh ãƒ¦ãƒ¼ã‚¶ãƒ¼: `root`
- ssh ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: `screencast`



```bash:Dockerfile
FROM ubuntu:16.04

RUN apt-get update && apt-get install -y openssh-server
RUN mkdir /var/run/sshd
RUN echo 'root:screencast' | chpasswd
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile

# FOR Ansible
RUN apt-get update && apt-get -y install python

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
```

```
$ docker build -t eg_sshd .
```

( [Dockerize an SSH service | Docker Documentation](https://docs.docker.com/engine/examples/running_ssh_service/) ã‚’å‚è€ƒ)

## Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ°ã‚‰ã›ã‚‹

```
$ docker run -d -p 30000:22 --name test_sshd eg_sshd
```

# Ansibleã®å®Ÿè¡Œ

## ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

æ‰‹å…ƒã«ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
( æ¥ç¶šå…ˆã®IPã¯Dockerã®æ§‹ç¯‰ç’°å¢ƒã«ã‚ˆã‚‹ )

```:inventory
[example]
127.0.0.1

[example:vars]
ansible_ssh_user=root
ansible_ssh_port=30000
```

( Ansible 2.0 ä»¥é™ã§ã¯ `ansible_user` ãªã©ã®çŸ­ã„æ›¸ãæ–¹ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§æ³¨æ„ => [Inventory â€” Ansible Documentation](http://docs.ansible.com/ansible/intro_inventory.html) )

## ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®è³ªå• ( known_inventory ã«ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã‚’è¨˜éŒ²ã™ã‚‹å‡¦ç† ) ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãŠãã€‚

```
$ export ANSIBLE_HOST_KEY_CHECKING=False
```

## ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

Dockerã‚³ãƒ³ãƒ†ãƒŠã«é©å½“ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã‚‹ã€‚

```
$ ansible -i inventory example -m shell -a 'touch example.txt' --ask-pass
```

- `-i inventory`
  - ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
- `-m shell`
  - ã€Œansible ã® shell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†æŒ‡å®š (çœç•¥ã§ãã‚‹)
- ` -a 'touch example.txt'`
  - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™å¼•æ•° ( ã“ã®ä¾‹ã®å ´åˆã¯ã€å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®å†…å®¹ )
- `--ask-pass`
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰‹å…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èã‹ã‚Œã‚‹ã®ã§ã€è¨­å®šã—ãŸã‚‚ã® ( `screencast` ) ã‚’å…¥åŠ›ã™ã‚‹ã€‚

# ç¢ºèª

docker ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚

```
$ docker exec -it test_sshd /bin/bash
```

```
root@91625cd5dda0:/# ls ~/
example.txt
```

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èã‹ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹å ´åˆ

## ãƒ›ã‚¹ãƒˆå´ã« sshpass ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

(Macã®å ´åˆ)

```
brew install https://raw.githubusercontent.com/kadwanev/bigboybrew/master/Library/Formula/sshpass.rb
```

( [Installing SSHPass](https://gist.github.com/arunoda/7790979) )

## æ‰‹å…ƒã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«sshã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ FingerPrint ã‚’ä½œã£ã¦ãŠã

```
ssh root@127.0.0.1 -p 30000
```

![image.png](https://qiita-image-store.s3.amazonaws.com/0/89618/2ee0ea45-96e2-3d7b-4a78-d2fb683ad49e.png)

`yes` ã¨ç­”ãˆã¦ `exit` ã™ã‚‹ã€‚

## ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›¸ã

ãŸã¶ã‚“éæ¨å¥¨ã€‚
( ã¡ã‚ƒã‚“ã¨ã‚„ã‚‹å ´åˆã¯éµäº¤æ›ã¨ã‹ã—ã‚ˆã† )

```diff:inventory
[example]
127.0.0.1

[example:vars]
ansible_ssh_user=root
ansible_ssh_port=30000
+ ansible_ssh_pass=screencast
```

## ansibleã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

```
ansible -i inventory example -m shell -a 'touch example.txt'
```


# ç’°å¢ƒ

- ansible 1.9.6
- Docker version 17.03.1-ce, build c6d412e
- Mac OS Sierra 10.12.4

# Docker hub

- [yumainaura/ansible-ssh - Docker Hub](https://hub.docker.com/r/yumainaura/ansible-ssh/)

# é–¢é€£

- [Ansible | ssh ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹ã«ã™ã‚‹ - Qiita](http://qiita.com/YumaInaura/items/4342199cab26d6453985)

# å‚è€ƒ

- [ansible - to use the 'ssh' connection type with passwords, you must install the sshpass program" - Stack Overflow](https://stackoverflow.com/questions/42835626/to-use-the-ssh-connection-type-with-passwords-you-must-install-the-sshpass-pr)








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2017-06-30
