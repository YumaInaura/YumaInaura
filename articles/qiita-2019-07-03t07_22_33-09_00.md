---
title: "#Ruby on #Rails ã§ has_one belongs_to has_many ãªã©ã® association ã‚’æŒã£ãŸãƒ†ãƒ¼ãƒ–ãƒ«"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Ruby", "Rails"]
published: true
published_at: 2019-07-03t07:22
---

å˜ä¸€æ¡ä»¶ã®å ´åˆã§ã‚ã‚Œã°ã€å˜ã« joins ã—ã¦ã‚ã’ã‚Œã°ã€çµåˆã§ããªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯é™¤ã‹ã‚Œã‚‹ã®ã§ã€ãã‚Œã§æ¸ˆã‚€ã¯ãšã€‚

```rb
User.joins(:books)
User.joins(:lovers)
```

ã§ã‚‚ ORã®è¤‡åˆçš„ãªæ¡ä»¶ã ã¨ã€ã„ã¡ã© LEFT OUTER JOIN ã‚’ã—ã¦ã‹ã‚‰ã˜ã‚ƒãªã„tã€ã†ã¾ãã„ã‹ãªã„æ°—ãŒã—ãŸã€‚

ãªã®ã§ã¾ãšã¯è¤‡æ•°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ LEFT JOIN ã—ã¦ã‹ã‚‰ã€è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ã€Œçµåˆã§ããŸã€ã‚‚ã®ã ã‘ã‚’çµã‚Šè¾¼ã‚“ã§è¦‹ãŸã€‚

```rb
User
  .left_joins(:books)
  .left_joins(:lovers)
  .where.not(books: {user_id: nil}).or(
	User
	  .left_joins(:books)
	  .left_joins(:lovers)
	  .where.not(lovers: {user_id: nil})
  )
  .distinct
```

SQLã¯ã“ã‚“ãªæ„Ÿã˜ã€‚


```
=> "SELECT DISTINCT `users`.* FROM `users` LEFT OUTER JOIN `books` ON `books`.`user_id` = `users`.`id` LEFT OUTER JOIN `lovers` ON `lovers`.`user_id` = `users`.`id` WHERE (`books`.`user_id` IS NOT NULL OR `lovers`.`user_id` IS NOT NULL)"
```

æœ€å¾Œã« distinct ã—ã¦ã„ã‚‹ã®ã¯ã€has_many ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ left join ã—ãŸæ™‚ã«ã€çµæœãŒå…ƒã® user æ•°ã‚ˆã‚Šã‚‚å¢—ãˆã‚‹ã®ã§ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦ã„ã‚‹ã€‚


# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2237








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2019-07-03
