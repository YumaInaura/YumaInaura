---
title: "Terraform + AWS EC2 / S3  - terraform init / apply ã®ã‚¨ãƒ©ãƒ¼ä¾‹ "
emoji: "ğŸ–¥"
type: "tech"
topics: ["AWS", "Terraform"]
published: true
published_at: 2023-02-02
---

# main.tf ã®ã‚³ãƒ¼ãƒ‰ä¾‹

```tf
terraform {
    # AWSãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
    required_providers {
        aws = {
            source  = "hashicorp/aws"
            version = "~> 4.51.0"
        }
    }
    # tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«é…ç½®ã™ã‚‹(é…ç½®å…ˆã®S3ã¯äº‹å‰ã«ä½œæˆæ¸ˆã¿)
    backend s3 {
        bucket = "terraform-yumainaura" # S3ãƒã‚±ãƒƒãƒˆå
        region = "ap-northeast-1"
        key    = "tf-test.tfstate"
    }
}

# AWSãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®å®šç¾©
provider aws {
    region = "ap-northeast-1"
}

# EC2ã®ä½œæˆ
resource aws_instance ec2 {
    ami           = "ami-0bba69335379e17f8" # Amazon ãƒã‚·ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸
    instance_type = "t2.micro"
    tags = {
        Name = "tf-test"
    }
}

```

# AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY ã‚’èªè­˜ã§ãã¦ã„ãªã„å ´åˆ (init) 

ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚èµ·ã“ã‚‹ã‚¨ãƒ©ãƒ¼
main.tf ã«ç›´æ¥ KEY / SECRET ã‚’æ›¸ãã‚„ã‚Šæ–¹ã ã¨ã“ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã„ãŸ

```
$ terraform init

Initializing the backend...
â•·
â”‚ Error: error configuring S3 Backend: no valid credential sources for S3 Backend found.
â”‚
â”‚ Please see https://www.terraform.io/docs/language/settings/backends/s3.html
â”‚ for more information about providing credentials.
â”‚
â”‚ Error: NoCredentialProviders: no valid providers in chain. Deprecated.
â”‚ 	For verbose messaging see aws.Config.CredentialsChainVerboseErrors
â”‚
â”‚
â”‚
â•µ
```

# AWS S3ã§ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆ (init) 

```
AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=yyy AWS_DEFAULT_REGION=ap-northeast-1 terraform init --migrate-state
```

```
Initializing the backend...
Backend configuration changed!

Terraform has detected that the configuration specified for the backend
has changed. Terraform will now check for existing state in the backends.

â•·
â”‚ Error: Error inspecting states in the "s3" backend:
â”‚     S3 bucket does not exist.
â”‚
â”‚ The referenced S3 bucket must have been previously created. If the S3 bucket
â”‚ was created within the last minute, please wait for a minute or two and try
â”‚ again.
â”‚
â”‚ Error: NoSuchBucket: The specified bucket does not exist
â”‚ 	status code: 404, request id: XSR798EMBAG06B70, host id: 2Pq7S6nh04co2JuD5bvpQfAe6kNnOTcYxoyEDubL32iQfu6WTFxxS5LTv7qtQZe5kGZL8Qh/w/k=
â”‚
â”‚
â”‚ Prior to changing backends, Terraform inspects the source and destination
â”‚ states to determine what kind of migration steps need to be taken, if any.
â”‚ Terraform failed to load the states. The data in both the source and the
â”‚ destination remain unmodified. Please resolve the above error and try again.
â”‚
â”‚
â•µ
```

# AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY ã®èªè¨¼æƒ…å ±ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆ  (init)

```
AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=yyy AWS_DEFAULT_REGION=ap-northeast-1 terraform init
```

```

Initializing the backend...
â•·
â”‚ Error: error configuring S3 Backend: error validating provider credentials: error calling sts:GetCallerIdentity: InvalidClientTokenId: The security token included in the request is invalid.
â”‚ 	status code: 403, request id: 6997596f-6935-4323-b732-498833c01f0f
â”‚
â”‚
```

# AWSã§S3æ¨©é™ãŒãªã„å ´åˆ (init)

```
AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=yyy AWS_DEFAULT_REGION=ap-northeast-1 terraform init
```

```
Initializing the backend...
Error refreshing state: AccessDenied: Access Denied
	status code: 403, request id: QEFSBRJ21TZCYTYH, host id: 72Qe8Vfz8mwzaCPil9yBAwFSBgomqccKgs+e7kftuXYDcoZqzOmRlFv3HeowawLejCJbEXBcBIw=
```

# AWSã§EC2æ¨©é™ãŒãªã„å ´åˆ (apply)

```
$ AWS_ACCESS_KEY_ID=xxxY AWS_SECRET_ACCESS_KEY=yyy AWS_DEFAULT_REGION=ap-northeast-1 terraform apply
```

```
aws_instance.ec2: Refreshing state... [id=i-07fa99fc63ad81002]

â•·
â”‚ Error: reading EC2 Instance (i-07fa99fc63ad81002): UnauthorizedOperation: You are not authorized to perform this operation.
â”‚ 	status code: 403, request id: f8df261f-6205-49a3-8585-f6d74adbc4ef
â”‚
â”‚   with aws_instance.ec2,
â”‚   on main.tf line 26, in resource "aws_instance" "ec2":
â”‚   26: resource aws_instance ec2 {
â”‚
â•µ
```

# ç’°å¢ƒ

```
Terraform v1.3.7
on darwin_amd64
+ provider registry.terraform.io/hashicorp/aws v4.51.0

```

# å‚è€ƒ

tfãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ã‚’å‚è€ƒã«ã—ãŸ(ã¨ã„ã†ã‹ã»ã¨ã‚“ã©ä¾‹ãã®ã¾ã¾ã§è©¦ã—ãŸ)

https://dev.classmethod.jp/articles/cloud9-terraform/

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura



# å…¬é–‹æ—¥æ™‚

2023-02-02
