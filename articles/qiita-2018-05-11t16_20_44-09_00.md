---
title: "docker + capistrano ã§ deploy ã®å‹•ä½œç¢ºèªã‚’ã™ã‚‹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Capistrano", "Docker"]
published: true
---


# sshæ¥ç¶šã‚µãƒ¼ãƒãƒ¼ã‚’dockerã§æ§‹æˆ

å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å‚è€ƒã« ssh æ¥ç¶šå¯èƒ½ãªã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ãŠãã€‚
ã“ã®ä¾‹ã§ã¯rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã™ã‚‹ã€‚


```:Dockerfile
FROM ubuntu:16.04

RUN apt-get update && apt-get install -y openssh-server
RUN mkdir /var/run/sshd
RUN echo 'root:screencast' | chpasswd
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
```

https://docs.docker.com/engine/examples/running_ssh_service/#build-an-eg_sshd-image

## ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ

```
$ docker image build . -t ssh_server
```

## port ã‚’æŒ‡å®šã—ã¦ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ

```
$ docker run -d -p 10000:22 ssh_server
```

## docker ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ Github ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã€ç§˜å¯†éµã‚’ç½®ã„ã¦ãŠãã€‚

Githubã«ã¯æ‰‹å…ƒã‹ã‚‰å…¬é–‹éµã§sshæ¥ç¶šã§ãã‚‹å‰æã€‚

æ–¹æ³•ã¯ä½•ã§ã‚‚è‰¯ã„ã€‚ã“ã®ä¾‹ã§ã¯ docker cp ã‚³ãƒãƒ³ãƒ‰ã§ã€ç›´æ¥æ‰‹å…ƒã‹ã‚‰ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

```
$ docker cp ~/.ssh/id_rsa_github_aiming ã‚³ãƒ³ãƒ†ãƒŠID:/root/.ssh
```

# capstrano ã‚’ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
$ gem install capistrano
```

```
$ cap install
```

# capistrano ã®è¨­å®šå¤‰æ›´

é©å½“ãªãƒ¬ãƒã‚¸ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã€‚
ã“ã®ä¾‹ã§ã¯ https://github.com/github/hub ã‚’ä½¿ã†ã€‚

ã¡ãªã¿ã«ãƒ¬ãƒã‚¸ãƒˆãƒªã®ä¸­èº«ã¯ä½•ã§ã‚‚è‰¯ã„ã€‚
(ãƒ¬ãƒã‚¸ãƒˆãƒªå´ã«capistranoé–¢ä¿‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…è¦ãªã„)


```deploy.rb
set :repo_url, "git@github.com:github/hub.git"
```

æ‰‹å…ƒã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ ( docker ã‚³ãƒ³ãƒ†ãƒŠ ) ã«ç¹‹ããŸã‚ã®è¨­å®šã‚’æ›¸ãã€‚

```deploy/production.rb
# The server-based syntax can be used to override options:
# ------------------------------------
server "localhost",
  user: "root",
  roles: %w{web app},
  ssh_options: {
    forward_agent: false,
    auth_methods: %w(password),
    port: 10000,
    password: "screencast"
  }
```

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

```
$ cap production deploy
```


# dockerã‚³ãƒ³ãƒ†ãƒŠã« deploy ã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç¢ºèª

```
root@8af7b375dc67:/# ls -la /var/www/my_app_name/
total 24
drwxr-xr-x 5 root root 4096 May 11 06:52 .
drwxr-xr-x 3 root root 4096 May 11 06:52 ..
lrwxrwxrwx 1 root root   44 May 11 06:52 current -> /var/www/my_app_name/releases/20180511065207
drwxr-xr-x 3 root root 4096 May 11 06:52 releases
drwxr-xr-x 7 root root 4096 May 11 06:52 repo
-rw-r--r-- 1 root root  106 May 11 06:52 revisions.log
drwxr-xr-x 2 root root 4096 May 11 06:52 shared
```

# ç’°å¢ƒ

- Capistrano Version: 3.10.2 (Rake Version: 12.0.0)
- Mac OS X Sierra
- Docker version 18.03.0-ce, build 0520e24








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->


