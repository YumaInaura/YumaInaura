---
title: "#Rails + #MySQL /  Transaction ã¨ INSERT RECORD ã¨ ROLLBACK ã§æ’ä»–åˆ¶å¾¡ã®å®Ÿé¨“"
emoji: "ğŸ–¥"
type: "idea"
topics: ["Rails", "MySQL"]
published: true
---



# ãƒ‘ã‚¿ãƒ¼ãƒ³1 - ãƒ—ãƒ­ã‚»ã‚¹A

INSERTã®ã‚ã¨ã€ã—ã°ã‚‰ãå¾Œç¶šã®å‡¦ç†ãŒç¶šããŒã€æœ€å¾Œã«ã¯å¤±æ•—ã™ã‚‹ã‚±ãƒ¼ã‚¹
Transactionå†…ã®å‡¦ç†ãŒå¤±æ•—ã—ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'X1'); sleep 15; raise; }
# (0.7ms)  BEGIN
# User Create (0.9ms)  INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('X1', '2020-01-09 08:18:34')
#
# ... wait ...
#
#  (10.4ms)  ROLLBACK
# from (pry):14:in `block in <main>'
```

# ãƒ‘ã‚¿ãƒ¼ãƒ³1 - ãƒ—ãƒ­ã‚»ã‚¹B 

ãƒ—ãƒ­ã‚»ã‚¹Aã®Transactionå†…ã§ã®å‡¦ç†ã¨é‡è¤‡ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’INSERTã™ã‚‹
ãƒ—ãƒ­ã‚»ã‚¹Aã®å‡¦ç†ãŒå¤±æ•—ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã€ã•ã‚‰ã«å¾Œç¶šã®å‡¦ç†ãŒé–‹å§‹ãƒ»æˆåŠŸã™ã‚‹

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'X1'); puts 'OK!'; }
# 
# (0.5ms)  BEGIN
#
# ... wait ...
#
# User Create (2573.1ms)  INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('X1', '2020-01-09 08:18:41')
# OK!
#  (9.4ms)  COMMIT
# => nil
```

# ãƒ‘ã‚¿ãƒ¼ãƒ³2 - ãƒ—ãƒ­ã‚»ã‚¹A

INSERTã®ã‚ã¨ã€ã—ã°ã‚‰ãå¾Œç¶šã®å‡¦ç†ãŒç¶šã„ã¦ã€æœ€å¾Œã«æˆåŠŸã™ã‚‹ã‚±ãƒ¼ã‚¹

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'X2'); sleep 15; puts 'OK!'; }
# (1.0ms)  BEGIN
# User Create (2.2ms)  INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('X2', '2020-01-09 08:22:14')
#
# ... wait ...
#
# OK!
#  (19.2ms)  COMMIT
# => nil
```

# ãƒ‘ã‚¿ãƒ¼ãƒ³2 - ãƒ—ãƒ­ã‚»ã‚¹B

ãƒ—ãƒ­ã‚»ã‚¹Aã®å‡¦ç†ãŒæˆåŠŸã™ã‚‹ã¾ã§ INSERT ã¯å¾…ã¡å—ã‘çŠ¶æ…‹ã«ãªã‚‹
ãƒ—ãƒ­ã‚»ã‚¹Aã®å‡¦ç†ãŒæˆåŠŸã—ã¦TransactionãŒçµ‚äº†ã™ã‚‹ã¨ã€ã“ã¡ã‚‰ã®INSERTã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶é™ã«åã™ã‚‹ã“ã¨ãŒç¢ºå®šã™ã‚‹ãŸã‚ã€ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ãŒå¤±æ•—ã™ã‚‹
INSERT ã‚ˆã‚Šå¾Œç¶šã®å‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œãªã„

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'X2'); puts 'OK!'; }
#
# ... wait ...
#
#    (0.6ms)  BEGIN
# User Create (6831.2ms)  INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('X2', '2020-01-09 08:22:22')
# (5.2ms)  ROLLBACK
# ActiveRecord::RecordNotUnique: Mysql2::Error: Duplicate entry 'X2' for key 'index_users_on_unique_id': INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('X2', '2020-01-09 08:22:22')
```

# ãƒ‘ã‚¿ãƒ¼ãƒ³3 - ãƒ—ãƒ­ã‚»ã‚¹A

ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åŒã˜ãã€INSERTã®å¾Œã«ã—ã°ã‚‰ãTransactionå†…ã®å‡¦ç†ãŒç¶šã

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'X3'); sleep 15; puts 'OK!'; }
```

# ãƒ‘ã‚¿ãƒ¼ãƒ³3 - ãƒ—ãƒ­ã‚»ã‚¹B

ãƒ—ãƒ­ã‚»ã‚¹Aã®Transactionå†…ã§ã®å‡¦ç†ã¨ã¯é‡è¤‡ã—ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’INSERTã™ã‚‹
ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶é™ã«å¼¾ã‹ã‚Œãªã„ç™»éŒ²ãªã®ã§ã€ã™ãã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚‹

```
ActiveRecord::Base.transaction { User.create!(unique_id: 'Y1'); puts 'OK!'; }
# (0.8ms)  BEGIN
# User Create (0.9ms)  INSERT INTO `users` (`unique_id`, `created_at`) VALUES ('Y1', '2020-01-09 08:18:38')
# OK!
#  (2.9ms)  COMMIT
# => nil
```

# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2927








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->


