---
title: #Stripe API  / ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ã§çµ‚äº†æ—¥ã‚’è¨­å®šã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸæ™‚ã®ã€æ—¥å‰²è¨ˆç®—çš„ãªèª¿æ•´é¡ = ã‚¤ãƒ³ãƒ´ã‚©ã‚¤ã‚¹
emoji: "ğŸ–¥"
type: "idea"
topics: ["stripe"]
published: true
---

# ãƒã‚¤ãƒ³ãƒˆ

- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ãŒæ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã—ã¦ã„ã‚‹æ™‚ã®å‹•ä½œç¢ºèªã€ãƒ†ã‚¹ãƒˆ
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã—ã¦ã„ã‚‹å ´åˆã¯ã€æ—¢ã«è«‹æ±‚ã¯ç™ºè¡Œã•ã‚Œã¦ãŠã‚Šã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æœŸé–“ã‚’å¤‰ãˆã‚‹ã¨ã€æ¬¡å›è«‹æ±‚ã®å†…å®¹ãŒã‚„ã‚Šãã‚Šã•ã‚Œã‚‹ã¿ãŸã„ã ã€‚
- 1æ—¥æœŸé–“ã®ãƒ—ãƒ©ãƒ³ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ãã£ã¡ã‚Š1æ—¥ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœŸé–“ãŒçµ‚ã‚ã‚‹ã‚ˆã†ã« end_date ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã€æ¬¡å›ã®è«‹æ±‚ã‚‚ç™ºç”Ÿã›ãšã€ãŸã ç´ ç›´ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã ã€‚
- 1æ—¥æœŸé–“ã®ãƒ—ãƒ©ãƒ³ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ã€æ—¢ã«è«‹æ±‚ãŒç™ºè¡Œã•ã‚Œã¦ãŠã‚Šã€ãªãŠã‹ã¤ãã‚Œã‚’åŠæ—¥ã«ç¸®ã‚ãŸå ´åˆã€æ¬¡å›è«‹æ±‚ã®æ—¥å‰²è¨ˆç®—ã®èª¿æ•´ã¨ã—ã¦ã€ãƒ—ãƒ©ãƒ³ã®åŠé¡ãŒè¿”é‡‘ã•ã‚Œã‚‹ã‚ˆã†ãªæŒ™å‹•ã‚’è¦‹ã›ãŸã€‚ã•ã‚‰ã«ãã‚Œã‚’å…ƒã®1æ—¥ã«æˆ»ã—ãŸå ´åˆã¯ã€ã•ã‚‰ã«æ¬¡å›è«‹æ±‚ãŒã‚„ã‚Šãã‚Šã•ã‚Œã¦ã€æ¬¡å›è«‹æ±‚ãŒ0å††ã«ãªã‚‹ã¿ãŸã„ã ã€‚å€¤æ®µã®ã¤ã˜ã¤ã¾ã¯åˆã£ã¦ã„ã‚‹ã®ã§æ­£ã—ã„ã€‚
- SubscriptionSchedule ã® end_behaviour ã¯ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® release ã§ã¯ãªã cancel ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
- ã“ã®è¨˜äº‹ã‚’æ›¸ã„ãŸå¾Œã§åˆ†ã‹ã£ãŸãŒã€ã©ã†ã‚„ã‚‰ SubscriptionSchedule ã®ä½œæˆæ™‚ã«ã‚‚æ—¥å‰²è¨ˆç®—ã®ç„¡åŠ¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚‰ã—ã„ ( prorate = false  ) ã€‚å°‘ã—è©¦ã—ãŸã¨ã“ã‚ã€ã“ã®æ™‚ã®æŒ™å‹•ã‚‚ãªã‚“ã ã‹åŒã˜ã‚ˆã†ã«è¦‹ãˆãŸãŒã€ã©ã†ã„ã†æ™‚ã«æŒ™å‹•ãŒå¤‰ã‚ã£ã¦ãã‚‹ã®ã ã‚ã†ã€‚è¿½ã£ã¦èª¿æŸ»ã—ãŸã„ã€‚

# Docs

https://stripe.com/docs/billing/subscriptions/subscription-schedules
https://stripe.com/docs/billing/subscriptions/subscription-schedules/use-cases
https://stripe.com/docs/api/subscription_schedules/release
https://support.stripe.com/questions/create-update-and-schedule-subscriptions

# Stripeã®åŸºæœ¬

æ—¥æœ¬æ­£å¼ãƒªãƒªãƒ¼ã‚¹ã—ãŸStripeã‚’ä½¿ã£ã¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹ - Qiita
https://qiita.com/tady/items/7617e62b2a5402ebd0fb

Stripe Billing 101 - Qiita
https://qiita.com/y_toku/items/235b5e7ee00792edcbbf

Stripeåˆå¿ƒè€…ã®ãŸã‚ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆRailsç·¨ï¼‰ - Qiita
https://qiita.com/ryouzi/items/6ee8f277471aa3b02f7b

# Code

```rb

require 'stripe'

Stripe::api_key = ENV['STRIPE_SECRET_KEY']

product1 = Stripe::Product.create(name: "Gold plan #{rand(9999999999)}")
plan1 = Stripe::Plan.create(interval: 'day', currency: 'jpy', amount: 5000, product: product1.id, usage_type: 'licensed')

tax_rate = Stripe::TaxRate.create(display_name: 'Tax Rate', percentage: 10.0, inclusive: false)
customer = Stripe::Customer.create
payment_method = Stripe::PaymentMethod.create(type: 'card', card: { number: '4242424242424242', exp_year: 2030, exp_month: 01})
customer_payment_method = Stripe::PaymentMethod.attach(payment_method.id, customer: customer.id)

def put_subscription_schedule(subscription_schedule, message)
  puts '-' * 100
  puts "Subscription Schedule"
  puts message
  puts '-' * 100
  puts subscription_schedule
  puts '-' * 100
  puts "https://dashboard.stripe.com/test/subscription_schedules/#{subscription_schedule.id}"
end

# https://stripe.com/docs/api/subscription_schedules/create
subscription_schedule = Stripe::SubscriptionSchedule.create(
  {
    customer: customer.id,
    start_date: Time.now.to_i + 5,
    default_settings: {
      default_payment_method: customer_payment_method.id,
    },
    phases: [
      {
        plans:
          [
            { plan: plan1.id, quantity: 1 },
          ],
        default_tax_rates: [tax_rate],
      },
    ],
  }
)
put_subscription_schedule(subscription_schedule, 'CREATED')

puts '-' * 100
puts "Wait until subscription schedule starts"
puts '-' * 100
until subscription_schedule.status == 'active' do
  subscription_schedule = Stripe::SubscriptionSchedule.retrieve(subscription_schedule.id)
  puts subscription_schedule.status
  sleep 2
end


def update_subscription_schedule(base_subscription_schedule, end_from_start_date: )
  Stripe::SubscriptionSchedule.update(
    base_subscription_schedule.id,
    {
      end_behavior: 'cancel',
      phases: [
        {
          plans:
            [
              {
                plan:     base_subscription_schedule.phases[0].plans[0].plan,
                quantity: base_subscription_schedule.phases[0].plans[0].quantity
              },
            ],
          default_tax_rates: [base_subscription_schedule.phases[0].default_tax_rates[0].id],
          start_date: base_subscription_schedule.phases[0].start_date,
          end_date: base_subscription_schedule.phases[0].start_date + end_from_start_date
        },
      ]
    }
  )
end


# STEP A
# Set subscrition canceled in one day, fit to plan natural cycle "day"
# It does not create proration adjustment or Upcoming invoice Because subscription schedule cycle is smart finishing.
#
# Happens events kinds are ...
#  subscription_schedule.updated
updated_subscription_schedule = update_subscription_schedule(subscription_schedule, end_from_start_date: 24*60*60)
put_subscription_schedule(updated_subscription_schedule, 'UPDATED')

# STEP B
# Set subscrition canceled in half a day.
# Not wait natural plan interval end.
# It makes proration adjustment half price of plan in Upcoming invoice.
#
#   Unused time on Gold plan xxxxxxxx after 02 Jan 2020 / 1 / -Â¥2,500
#
#   Subtotal -Â¥2,500
#   Tax Rate (10%) -Â¥250
#   Total -Â¥2,750
#   Applied balance Â¥2,750
#   Amount due Â¥0
#
# Happens events kinds are ...
#   subscription_schedule.updated
#   customer.subscription.updated
#   invoiceitem.created
updated_subscription_schedule = update_subscription_schedule(subscription_schedule, end_from_start_date: 12*60*60)
put_subscription_schedule(updated_subscription_schedule, 'UPDATED')

# STEP C
# Set subscription back natural full ony day.
# It makes Upcoming Invoice plice zero
#
#   Time on Gold plan xxxxxxxx after 02 Jan 2020 / 1 / Â¥2,500
#   Unused time on Gold plan xxxxxxxx after 02 Jan 2020 / 1 / -Â¥2,500
#
#   Subtotal Â¥0
#   Tax Rate (10%) Â¥0
#   Total Â¥0
#   Amount due Â¥0
updated_subscription_schedule = update_subscription_schedule(subscription_schedule, end_from_start_date: 24*60*60)
put_subscription_schedule(updated_subscription_schedule, 'UPDATED')

# STEP D
#   Gold plan 5392253972 / 1 / Â¥5,000 / Â¥5,000
#   Unused time on Gold plan 5392253972 after 02 Jan 2020 / 1 / -Â¥2,500
#
#   Subtotal Â¥2,500
#   Tax Rate (10%) Â¥250
#   Total Â¥2,750
#   Amount due Â¥2,750
updated_subscription_schedule = update_subscription_schedule(subscription_schedule, end_from_start_date: 36*60*60)
put_subscription_schedule(updated_subscription_schedule, 'UPDATED')

```

# BEFORE UPDATE

ç„¡æœŸé™ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ãŸã‚ã€çµ‚äº†æ—¥ã¯ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„
æ¬¡å›è«‹æ±‚ã‚‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹

![image](https://user-images.githubusercontent.com/13635059/71647420-2b896880-2d3a-11ea-96fe-80bd5d62024b.png)
![image](https://user-images.githubusercontent.com/13635059/71647829-5d50fe00-2d3f-11ea-8db3-30305e5006c8.png)

# STEP A

Ends was set
ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã¡ã‚‡ã†ã©ç¾åœ¨æœŸé–“ã§çµ‚ã‚ã‚‹ã‚ˆã†ã«è¨­å®šã—ãŸå ´åˆ
çµ‚äº†æ—¥ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹
æ¬¡å›è«‹æ±‚ã¯æ¶ˆãˆãŸ

![image](https://user-images.githubusercontent.com/13635059/71647438-54a9f900-2d3a-11ea-8809-d4e27f9b8436.png)



# STEP B

Upcoming invoice occurs
ç¾åœ¨æœŸé–“ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœŸé–“ã‚’åŠæ—¥ã«ç¸®ã‚ãŸå ´åˆ
æ¬¡å›è«‹æ±‚ã§ã®èª¿æ•´é¡ãŒç™ºç”Ÿã—ã¦ã„ã‚‹

![image](https://user-images.githubusercontent.com/13635059/71647445-6e4b4080-2d3a-11ea-9b55-b2cccb7200ea.png)


# STEP C

next Upcoming invoice occurs
ç¾åœ¨æœŸé–“ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœŸé–“ã‚’åŠæ—¥ã«ç¸®ã‚ãŸå¾Œã€1æ—¥ã«æˆ»ã—ãŸå ´åˆ
æ¬¡å›è«‹æ±‚ã§ã®èª¿æ•´é¡ã«å¯¾ã—ã¦ã•ã‚‰ã«èª¿æ•´é¡ãŒç™ºç”Ÿã—ã¦ã€è«‹æ±‚ã¯0å††ã«ãªã£ã¦ã„ã‚‹

![image](https://user-images.githubusercontent.com/13635059/71647457-84f19780-2d3a-11ea-82d2-ec96fbb43f1f.png)

# STEP D

![image](https://user-images.githubusercontent.com/13635059/71647468-bc604400-2d3a-11ea-9470-410ab279bda5.png)


# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2909








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->


