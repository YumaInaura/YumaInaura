---
title: "docker ã€Œã‚³ãƒ³ãƒ†ãƒŠã‚’ ssh æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹Dockerfileã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è§£èª¬"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Docker"]
published: true
published_at: 2018-06-18t15:01
---

dockerãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã«ç›´æ¥sshæ¥ç¶šã™ã‚‹ä¾‹ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚

[Dockerize an SSH service | Docker Documentation](https://docs.docker.com/engine/examples/running_ssh_service/)

# æ¦‚è¦

ç‰¹åˆ¥ãªã“ã¨ã¯ä½•ã‚‚ã—ã¦ã„ãªã„ã€‚
dockerçš„ãªè§£æ±ºã§ã¯ãªãã€å˜ã«ã‚µãƒ¼ãƒãƒ¼çš„è§£æ±ºã‚’ãŠã“ãªã†ã€‚

è¦ã™ã‚‹ã«ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã¦ã‹ã‚‰ã€ssï½ˆæ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¾ã§ã®æ‰‹é †ã‚’Dockerfileã«æ›¸ã„ã¦ãŠã‘ã°è‰¯ã„ã€‚

# Dockefile



```bash
FROM ubuntu:16.04

RUN apt-get update && apt-get install -y openssh-server
RUN mkdir /var/run/sshd
RUN echo 'root:screencast' | chpasswd
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
```


# Dockerfileã®è§£èª¬

## sshã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```
RUN apt-get update && apt-get install -y openssh-server
```

ã‚µãƒ¼ãƒãƒ¼ãªã—ã«ã¯sshæ¥ç¶šã¯ã§ãã¬ã€‚

## sshç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„ã¨sshdãŒå‹•ã‹ãªã„ã£ã½ã„ã€‚

```
RUN mkdir /var/run/sshd
```

## rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹

`chpasswd` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã™ã‚‹ã€‚Linuxã®åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰ã§ã‚ã‚‹ã€‚
ã“ã®ä¾‹ã§ã¯ `root` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« `screencast` ã¨ã„ã†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚

```
RUN echo 'root:screencast' | chpasswd
```

## rootã§ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹

sshd_config ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼·å¼•ã«æ›¸ãæ›ãˆã¦ã®è¨­å®šå¤‰æ›´ã€‚

```
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
```

OpenSSHã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚‚ã‚ˆã‚‹ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã¯é€šå¸¸ã€ root ã«ç›´æ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã€‚

[ã€ŒOpenSSH 7.0ã€ãŒãƒªãƒªãƒ¼ã‚¹ã€PermitRootLoginè¨­å®šã®å¤‰æ›´ãªã©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãŒè¡Œã‚ã‚Œã‚‹ | OSDN Magazine](https://mag.osdn.jp/15/08/14/072400)

## ä½•ã‹ã®ãŠã¾ã˜ãªã„

æ­£è¦è¡¨ç¾ã®ã›ã„ã§èª­ã¿ã¥ã‚‰ã„ãŒ `/etc/pam.d/sshd` ã®è¨­å®šã‚’æ›¸ãæ›ãˆã¦ã„ã‚‹ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€ã“ã‚Œã‚’æ›¸ã‹ãªã„ã¨ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã‚­ãƒƒã‚¯ã•ã‚Œã¦ã—ã¾ã†ã‚‰ã—ã„ã€‚

```
# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
```
```diff
- sessionã€€ã€€requiredã€€ã€€pam_loginuid.so
+ sessionã€€ã€€optionalã€€ã€€pam_loginuid.so
```

(ã ãŒè©¦ã—ã«ã“ã®è¡Œã‚’æ¶ˆã—ã¦ã¿ãŸã¨ã“ã‚ã€ç‰¹ã«å•é¡Œãªãsshãƒ­ã‚°ã‚¤ãƒ³ã§ããŸ)

[ubuntu - Why is it needed to set `pam_loginuid` to its `optional` value with docker? - Stack Overflow](https://stackoverflow.com/questions/21391142/why-is-it-needed-to-set-pam-loginuid-to-its-optional-value-with-docker)


# ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™ä¾‹

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã¯ã‚ãã¾ã§ä¾‹ã‚’æ›¸ã„ã¦ã„ã‚‹ã ã‘ã§ã€ç‰¹ã«æ„å‘³ã®ã‚ã‚‹ã“ã¨ã¯ã—ã¦ã„ãªã„ã‚ˆã†ãªã€‚(ã“ã®äºŒè¡Œã‚’æ¶ˆã—ã¦ã‚‚å‹•ã)

```
ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile
```

- [bash - Why set VISIBLE=NOW in /etc/profile? - Stack Overflow](https://stackoverflow.com/questions/36292317/why-set-visible-now-in-etc-profile)

# 22ç•ªãƒãƒ¼ãƒˆã‚’æ™’ã™

```
EXPOSE 22
```

# sshã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

èµ·å‹•ã›ãšã«ã¯sshã¯ä½¿ãˆã¬ã€‚

```
CMD ["/usr/sbin/sshd", "-D"]
```

# å‚è€ƒ

- [ubuntu 11.04 xinetdçµŒç”±ã§ï½“ï½“ï½ˆdã‚’èµ·å‹•ã™ã‚‹ï¼ˆè¨­å®šã®å¤‰æ›´ï¼‰: è±†è…ã¨è’Ÿè’»](http://tofutokonnyaku.cocolog-nifty.com/blog/2011/06/ubuntu-1104-x-2.html)
- [PAMã®å½¹å‰² | OpenGroove](https://open-groove.net/lpic/pam-modules/)








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2018-06-18
