---
title: "#Rails + MySQL ã§ timestamps ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿˜ã‚Œã¦ã„ãŸã®ã§å¾Œã‹ã‚‰ created_at / updated_"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Rails"]
published: true
published_at: 2019-12-29t09:21
---

# points

- null ã‚’è¨±å¯ã—ã¦ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹ã€‚
- å…¨ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å€¤ã‚’å…¥ã‚Œã‚‹ã€‚
- null ã‚’ä¸è¨±å¯ã«å¤‰ãˆã‚‹ã€‚

# warning 

ã‚«ãƒ©ãƒ 1å€‹ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ timestams ã§ã‚‚ãªã timestamp ã§ã‚‚ãªãã¦ datetime ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã«æ³¨æ„ã€‚

( ã‚ãªãŸã® Rails ã® t.timestamps ã¯ datetime å‹ã®ã‚«ãƒ©ãƒ ã‚’ MySQL ã«è¿½åŠ ã—ã¦ã„ã‚‹ã‹ï¼Ÿ ç’°å¢ƒã«ã‚ˆã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚ç¢ºèªã—ã¦ã»ã—ã„ )


# migration

```rb
class AddCreatedAtToUser < ActiveRecord::Migration[5.2]
  def up
    add_column :users, :created_at, :datetime, null: true

    User.update_all(created_at: Time.current)

    change_column :users, :created_at, :datetime, null: false
  end

  def down
    remove_column :users, :created_at
  end
end
```

æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œã£ãŸä¸Šã§

```rb
bundle exec rails db:migrate
bundle exec rails db:rollback
```

ãªã©ã‚’å®Ÿè¡Œã—ã¦è©¦ã—ã¦ã¿ã‚ˆã†ã€‚

#  null ã‚’è¨±å¯ã›ãšã«ã‚«ãƒ©ãƒ è¿½åŠ ã—ãŸå ´åˆ

null ã‚’è¨±å¯ã—ãªã„å ´åˆã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã§migrationãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã—ã¾ã†ã€‚

```rb
class AddCreatedAtToUser < ActiveRecord::Migration[5.2]
  def change
    add_column :users, :created_at, :datetime, null: false
  end
end
```

```
StandardError: An error has occurred, all later migrations canceled:

Mysql2::Error: Incorrect datetime value: '0000-00-00 00:00:00' for column 'created_at' at row 1: ALTER TABLE `users` ADD `created_at` datetime NOT NULL

...

Caused by:
ActiveRecord::StatementInvalid: Mysql2::Error: Incorrect datetime value: '0000-00-00 00:00:00' for column 'created_at' at row 1: ALTER TABLE `users` ADD `created_at` datetime NOT NULL
```

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æŒ‡å®šã—ãŸå ´åˆ

```rb
class AddCreatedAtToUser < ActiveRecord::Migration[5.2]
  def change
    add_column :users, :created_at, :datetime, null: false, default: -> { 'NOW()' }
  end
end
```

migrationã¯å‡ºæ¥ã‚‹ãŒã‚«ãƒ©ãƒ ã« defaultå€¤ãŒè¨­å®šã•ã‚Œã¦ã—ã¾ã„ã€ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ™‚ã« t.timestamps ã‚’æŒ‡å®šã—ãŸçŠ¶æ…‹ã¨ã¯é•ã£ã¦ã—ã¾ã†ã€‚

```
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
```

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šã—ã€å¾Œã‹ã‚‰å‰Šé™¤ã—ã‚ˆã†ã¨ã—ãŸå ´åˆ

ã‚µãƒ¼ãƒãƒ¼è¨­å®šã®ã›ã„ã‹ã†ã¾ãè¡Œã‹ãªã‹ã£ãŸã€‚

```rb
class AddCreatedAtToUser < ActiveRecord::Migration[5.2]
  def change
    add_column :users, :created_at, :datetime, null: false, default: -> { 'NOW()' }
    change_column :users, :created_at, :datetime, null: false, default: ''
  end
end
```

```
rails aborted!
StandardError: An error has occurred, all later migrations canceled:

Mysql2::Error: Invalid default value for 'created_at': ALTER TABLE `users` CHANGE `created_at` `created_at` datetime DEFAULT NULL NOT NULL
...

Caused by:
ActiveRecord::StatementInvalid: Mysql2::Error: Invalid default value for 'created_at': ALTER TABLE `users` CHANGE `created_at` `created_at` datetime DEFAULT NULL NOT NULL
```


Ref

mysqlã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã—ãŸã‚‰Invalid default value for ã‚¨ãƒ©ãƒ¼ - Qiita
https://qiita.com/rh_/items/be798e69a8f9000c56b1

Setting MySQL DATETIME column defaults in Rails
https://www.mikeperham.com/2014/05/17/setting-mysql-datetime-column-defaults-in-rails/

# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2883








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2019-12-29
