---
title: "AWS Codepipeline ã§ ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ™‚ã®è¦ç‚¹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["AWS", "ECS", "CodePipeline"]
published: true
---


# buildspec.yml

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€šã‚Šã®ã ã„ãŸã„ã“ã‚“ãªã‚„ã¤ã‚’ä½¿ã†

https://docs.aws.amazon.com/ja_jp/codepipeline/latest/userguide/ecs-cd-pipeline.html

```yaml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws --version
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin 012345678910.dkr.ecr.us-west-2.amazonaws.com
      - REPOSITORY_URI=012345678910.dkr.ecr.us-west-2.amazonaws.com/hello-world
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - echo Writing image definitions file...
      - printf '[{"name":"hello-world","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
    files: imagedefinitions.json
```

# ã‚„ã£ã¦ã„ã‚‹å†…å®¹

- Dockerfileã‚’buildã—ã¦ECRã«pushã—ã¦ã„ã‚‹ ( latest ã¨ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«ã—ãŸã‚‚ã®ã®2å€‹ )
- `imagedefinitions.json` ã‚’ãƒ“ãƒ«ãƒ‰å†…ã§ç›´æ¥ä½œæˆã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã«ä½¿ã£ã¦ã„ã‚‹


ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä¾‹ã ã¨ç”Ÿæˆã•ã‚Œã‚‹ `imagedefinitions.json` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®

```json
[
  {
    "name": "hello-world",
    "imageUri": "012345678910.dkr.ecr.us-west-2.amazonaws.com/hello-world:[ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥]"
  }
]
```

å†…å®¹ã¯ä»¥ä¸‹ã«è©³ã—ã„
https://docs.aws.amazon.com/ja_jp/codepipeline/latest/userguide/ecs-cd-pipeline.html#cd-buildspec

# è¦ç‚¹

- AWS ã® CodePipeline ã®ä½œæˆç”»é¢ã¯ã‹ãªã‚Šè¦ªåˆ‡ã§æ‰‹é †ã«å¾“ã†ã ã‘ã§åŸºæœ¬çš„ãªé€£æºã¯å‡ºæ¥ãŸã€‚(è‡ªåˆ†ã®å ´åˆã¯Github 2ã§é€£æºã•ã›ãŸ)
- ECSã®ã‚¯ãƒ©ã‚¹ã‚¿ã¨ã‚µãƒ¼ãƒ“ã‚¹ã¯äº‹å‰ã«ä½œæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚
- `buildspec.yaml` ã¨ `Dockerfile` ã‚’Githubãªã©ã®ã‚½ãƒ¼ã‚¹ãƒ¬ãƒã‚¸ãƒˆãƒªã«å«ã‚ã¦ãŠãã“ã¨ã€‚
- ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹æ™‚ã«ã¯ã€Œç‰¹æ¨©ä»˜ä¸ã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã€‚ãã†ã—ãªã„ã¨ docker build ãªã©ã®dockerç³»ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã™ã‚‹ã€‚ ( `
Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ã™ã‚‹ã‹ã€ãƒ“ãƒ«ãƒ‰ã§æ˜‡æ ¼ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ã“ã®ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹ã«ã—ã¾ã™` )
- ã“ã®ä¾‹ã®ã‚ˆã†ãª `buildspec.yml` ã«æ›¸ã„ã¦ã‚ã‚‹æ‰‹é †ã¯è¦ã™ã‚‹ã«ã‚³ãƒãƒ³ãƒ‰ã®ç¾…åˆ—ã«éããªã„ã®ã§ local ã§ã‚‚å†ç¾ã§ãã‚‹ã‚‚ã®ãŒå¤šã„ã€‚localã§ã‚‚å‹•ä½œç¢ºèªã—ãªãŒã‚‰è©¦ã™ã“ã¨ã€‚
- `ls` ã¨ã‹ `docker pull aplpine` ã¨ã‹ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚‚ `buildspec.yaml` ã«æ›¸ã‘ã‚‹ã®ã§ãƒ‡ãƒãƒƒã‚°ç”¨ã«ä»•è¾¼ã‚“ã§ã„ãã®ã‚‚è‰¯ã„ã€‚
- å®Ÿéš›ã«ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä¾‹ã‚’æ›¸ãæ›ãˆã¦è©¦ã—ãŸã€‚AWS ECR ã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚Œã°ã¦ãã¨ã†ã« `buildspec.yaml` ã®ãƒ¬ãƒã‚¸ãƒˆãƒªåãªã©ã‚’æ›¸ãæ›ãˆã‚‹ã®ã¯ç°¡å˜ã ã‚ã†ã€‚

# TIPS

ç©ºã®ã‚³ãƒŸãƒƒãƒˆã‚’pushã™ã‚‹ã¨1ã‚³ãƒãƒ³ãƒ‰ã§Pipelineã‚’å›ã›ã‚‹

```
git commit --allow-empty -m empty && git push
```

# ãƒ“ãƒ«ãƒ‰

## docker build ãŒå¤±æ•—ã™ã‚‹

```
Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?

[Container] 2023/03/30 03:50:28 Running command docker build -t $REPOSITORY_URI:latest .
Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?

[Container] 2023/03/30 03:50:28 Command did not exit successfully docker build -t $REPOSITORY_URI:latest . exit status 1
[Container] 2023/03/30 03:50:28 Phase complete: BUILD State: FAILED
[Container] 2023/03/30 03:50:28 Phase context status code: COMMAND_EXECUTION_ERROR Message: Error while executing command: docker build -t $REPOSITORY_URI:latest .. Reason: exit status 1
```

Codebuildã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç‰¹æ¨©ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/89618/e5182d24-7fb2-0215-4dab-61856734e50d.png)

https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/troubleshooting.html#troubleshooting-cannot-connect-to-docker-daemon

## aws ecr get-login-password ãŒå¤±æ•—ã™ã‚‹

ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã§ `EC2InstanceProfileForImageBuilderECRContainerBuilds` ã® IAM ãƒãƒªã‚·ãƒ¼ã‚’è¨±å¯ã—ã¦è§£æ±ºã—ãŸ

CodeBuild > ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ > ãƒ“ãƒ«ãƒ‰ã®è©³ç´° > ç’°å¢ƒ > ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«


# docker rate limit å¯¾ç­–

buildspec.yml ã§ docker ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è‰¯ã„ã‚ˆã†ã 

ä»¥ä¸‹ã®ä¾‹ã ã¨2å›ã® docker login ãŒãŠã“ãªã‚ã‚Œã‚‹
ä»Šã¾ã§çŸ¥ã‚‰ãªã‹ã£ãŸãŒ docker login ã§ã¯å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼å˜ä½ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½ãªæ§˜å­

ä»¥ä¸‹ã®ã²ã¨ã¤ã¯ docker build ã®æ™‚ã®ãŸã‚
ã‚‚ã†ã²ã¨ã¤ã¯ AWS ECR ã¸ã® push ã®ãŸã‚

```yml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws --version
      # buildã®ãŸã‚ã®ãƒ­ã‚°ã‚¤ãƒ³
      - echo "$DOCKER_HUB_PASSWORD" | docker login --username "$DOCKER_HUB_ID" --password-stdin
      - REPOSITORY_URI=xxx.dkr.ecr.ap-northeast-1.amazonaws.com/foo
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
  build:
    commands:
      # çœç•¥
  post_build:
    commands:
      # pushã®ãŸã‚ã®ãƒ­ã‚°ã‚¤ãƒ³
      - $(aws ecr get-login --no-include-email --region ap-northeast-1)
      - echo Build completed on `date`
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - echo Writing image definitions file...
      - printf '[{"name":"container-name","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
    files: imagedefinitions.json
    
```

ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç’°å¢ƒå¤‰æ•°ã«

DOCKER_HUB_ID
DOCKER_HUB_PASSWORD
ã®ã‚ˆã†ãªç’°å¢ƒå¤‰æ•°ã‚’èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹

CodeBuild > ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ > (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå) > ç’°å¢ƒ ã‚’ç·¨é›†

dockerhubã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè‡ªä½“ã¯äº‹å‰ã«ä½œæˆã—ã¦ãŠãã“ã¨




## ãƒ“ãƒ«ãƒ‰æ™‚ã®ã‚¨ãƒ©ãƒ¼: because no identity-based policy allows the ssm:GetParameters action

ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã«SSMã®è¨±å¯ãƒãƒªã‚·ãƒ¼ãŒãªã„å ´åˆã«ç™ºç”Ÿ

è‡ªåˆ†ã®å ´åˆã¯ `AmazonSSMReadOnlyAccess` ã‚’è¨­å®šã—ã¦è§£æ±ºã—ãŸ

```
arn:aws:sts::842696858454:assumed-role/codebuild-ex-build-project-service-role/AWSCodeBuild-b5f8b8c5-1fc0-4794-930b-c03f3825b15f is not authorized to perform: ssm:GetParameters on resource: arn:aws:ssm:ap-northeast-1:842696858454:parameter/example@example.com because no identity-based policy allows the ssm:GetParameters action
    status code: 400, request id: e445e913-1648-47f7-ba55-1ce654f6d9a4
```

## ãƒ“ãƒ«ãƒ‰æ™‚ã®ã‚¨ãƒ©ãƒ¼:  Variables Error Message: parameter does not exist:

ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç’°å¢ƒå¤‰æ•°ã§ã‚¿ã‚¤ãƒ—ã‚’ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ã«ã—ã¦ã„ã‚‹ã®ã«åå‰ã¨å€¤ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ã„ãŸã®ãŒåŸå› ã ã£ãŸ

<img width="721" alt="image" src="https://user-images.githubusercontent.com/13635059/217715851-a21c31cb-8b1a-44fe-9a69-10d114706d7e.png">

SSMã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã†å ´åˆã¯

- ã€Œåå‰ã€ãŒãƒ“ãƒ«ãƒ‰å†…ã§ã®ç’°å¢ƒå¤‰æ•°å
- ã€Œå€¤ã€ãŒSSMã§ã®ã‚­ãƒ¼å

ã«ãªã‚‹ã‚ˆã†ã ã€‚
ç”»é¢å†…ã®ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½œæˆã€ã‚’ä½¿ãˆã°é–“é•ã„ãŒãªã‹ã£ãŸ

![image](https://user-images.githubusercontent.com/13635059/217715761-0306dc46-3dcd-4714-b25e-d19482acbdba.png)


```
Phase context status code: Decrypted Variables Error Message: parameter does not exist: example@example.com
```


## ãƒ“ãƒ«ãƒ‰ã«æˆåŠŸã—ãŸæ™‚

AWS ECSã®ã€Œã‚¿ã‚¹ã‚¯å®šç¾©ã€ã§æ–°ã—ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãŒå‡ºæ¥ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹

# ãƒ‡ãƒ—ãƒ­ã‚¤

## ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠå

```
The AWS ECS container ***** does not exist
```

`imagedefinitions.json` ã®nameã«ã¯ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠåã‚’æ¸¡ã™ã‚ˆã†ã 
(ã‚¿ã‚¹ã‚¯å®šç¾©ãã®ã‚‚ã®ã®åå‰ã§ã¯ãªããã®ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠå)

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®yamlã®ä¾‹ã ã¨ ECRã®ãƒ¬ãƒã‚¸ãƒˆãƒªåã‚‚ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠåã‚‚ `hello-world` ãªã®ã§åˆ†ã‹ã‚Šã¥ã‚‰ã„ãŒ


AWS ã‚¿ã‚¹ã‚¯å®šç¾©ã®ç”»é¢ã«ã€Œã‚³ãƒ³ãƒ†ãƒŠã€ã‚¿ãƒ–ãŒã‚ã‚‹ã®ã§ãã“ã§ç¢ºèªã™ã‚‹


## ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã—ãŸæ™‚

ECSã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã¦æˆåŠŸã™ã‚‹ã®ãŒåˆ†ã‹ã‚‹

