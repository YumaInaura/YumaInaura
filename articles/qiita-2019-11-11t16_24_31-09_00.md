---
title: "#Ruby ã® aasm gem ã§ callback ã® LifeCycle ã‚’å‹•ä½œç¢ºèªã™ã‚‹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Ruby"]
published: true
published_at: 2019-11-11t16:24
---

# NOTE

- ã‹ãªã‚Šç´°ã‹ãcallbackã®å±¤ãŒåˆ†ã‹ã‚Œã¦ãŠã‚Šã€æŸ”è»Ÿã«æŒ‡å®šã§ããã†ã€‚
- ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ aasm.current_event ã§å¾—ã‚‰ã‚Œã‚‹ã€‚
- aasm.from_state / aasm.to_state ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®BEFORE AFTER ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚
- callback ã® aasm.events ã§ã¯ã€ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ¬¡ã«åˆ©ç”¨å¯èƒ½ãªã‚¤ãƒ™ãƒ³ãƒˆãŒé…åˆ—ã§å¾—ã‚‰ã‚Œã‚‹ã£ã½ã„ã€‚after_all_transitions ã¨ after_all_events ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§çŠ¶æ…‹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚
- initial ã« callback æŒ‡å®šã‚’ã—ã¦ã‚‚ new ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã—ãŸæ™‚ç‚¹ã§ callback ãŒèµ°ã‚‹ã‚ã‘ã§ã¯ãªã„ã‚‰ã—ã„ã€‚
 

# Lifecycle

![image](https://user-images.githubusercontent.com/13635059/68553220-9ddc7b80-0462-11ea-93bd-04ede9c2fd3b.png)

[aasm/aasm: AASM - State machines for Ruby classes (plain Ruby, ActiveRecord, Mongoid)](https://github.com/aasm/aasm#lifecycle)

# Code

```rb
require 'aasm'

class Job
  include AASM

  aasm do
    state :sleeping, initial: true, before_enter: :log_status_change_before_enter
    state :running, :cleaning

    event :run do
      transitions from: :sleeping, to: :running
    end

    event :clean do
      transitions from: :running, to: :cleaning
    end

    event :sleep do
      transitions from: [:running, :cleaning], to: :sleeping
    end

    event :down do
      transitions from: [:running, :cleaning], to: :sleeping
    end

    before_all_events     :log_status_change_before_all_events
    after_all_transitions :log_status_change_after_all_transitions
    after_all_events      :log_status_change_after_all_events
  end

  def log_status_change_before_enter
    puts '[before_enter]'
    puts "changing from #{aasm.from_state} to #{aasm.to_state} (current_event: #{aasm.current_event})"
    puts
  end

  def log_status_change_before_all_events
    puts '[before_all_events]'
    log_change_status
  end

  def log_status_change_after_all_transitions
    puts '[after_all_transitions]'
    log_change_status
  end

  def log_status_change_after_all_events
    puts '[after_all_events]'
    log_change_status
  end

  def log_change_status
    puts "changing from #{aasm.from_state} to #{aasm.to_state} (current_event: #{aasm.current_event}) (events: #{aasm.events.map(&:name)})"
    puts
  end

end

# no callback happen
job = Job.new

job.run
job.clean
job.sleep

# [before_all_events]
# changing from  to  (current_event: run) (events: [:run])

# [after_all_transitions]
# changing from sleeping to running (current_event: run) (events: [:run])

# [after_all_events]
# changing from sleeping to running (current_event: run) (events: [:clean, :sleep, :down])

# [before_all_events]
# changing from sleeping to running (current_event: clean) (events: [:clean, :sleep, :down])

# [after_all_transitions]
# changing from running to cleaning (current_event: clean) (events: [:clean, :sleep, :down])

# [after_all_events]
# changing from running to cleaning (current_event: clean) (events: [:sleep, :down])

# [before_all_events]
# changing from running to cleaning (current_event: sleep) (events: [:sleep, :down])

# [after_all_transitions]
# changing from cleaning to sleeping (current_event: sleep) (events: [:sleep, :down])

# [after_all_events]
# changing from cleaning to sleeping (current_event: sleep) (events: [:run])


```

# ref

[AASM - classã®çŠ¶æ…‹é·ç§»ã‚’ã‚¹ãƒãƒ¼ãƒˆã«å®Ÿè£…ã™ã‚‹ãŸã‚ã®gem (Ruby, Active Record, Sequel, Mongoid) - Qiita](https://qiita.com/satour/items/fe838dc21dc95df95c62)


# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2709








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2019-11-11
