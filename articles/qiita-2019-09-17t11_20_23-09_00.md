---
title: "#Rails ã® ActiveJob + shoryuken gem ã§ #AWS SQS ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°éåŒæœŸå‡¦ç†ã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Rails", "AWS"]
published: true
published_at: 2019-09-17
---

# ãƒã‚¤ãƒ³ãƒˆ

- shoryuken ã® Worker ã‚’èµ·å‹•ã™ã‚‹
- å‡¦ç†å†…å®¹ã¯ Worker ã«è¡¨ç¤ºã•ã‚Œã‚‹

# Worker ã®èµ·å‹•

- å¿…ãš `--rails` ãƒ•ãƒ©ã‚°ã‚’ã¤ã‘ã‚‹ã“ã¨ã€‚ã“ã†ã—ãªã„ã¨ActiveJob ã‹ã‚‰ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°è‡ªä½“ã¯ã§ãã‚‹ã‚‚ã®ã®ã€è‚å¿ƒã® perform ã§ã®å‡¦ç†å†…å®¹ãŒå®Ÿè¡Œã•ã‚Œãªè²·ã£ãŸã€‚
- `--config` ã§ yml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã€‚
- `--require ã§ Worker ã® Ruby ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã€‚`

```
bundle exec shoryuken --config config/shoryuken.yml --require --rails
```


# Help

```
shoryuken --help

shoryuken [options]
    -c, --concurrency INT            Processor threads to use
    -d, --daemon                     Daemonize process
    -q, --queue QUEUE[,WEIGHT]...    Queues to process with optional weights
    -r, --require [PATH|DIR]         Location of the worker
    -C, --config PATH                Path to YAML config file
    -R, --rails                      Attempts to load the containing Rails project
    -L, --logfile PATH               Path to writable logfile
    -P, --pidfile PATH               Path to pidfile
    -v, --verbose                    Print more verbose output
    -V, --version                    Print version and exit
    -h, --help                       Show help
```

https://www.rubydoc.info/github/phstc/shoryuken

# AWS SQS ã§ã® ã‚­ãƒ¥ãƒ¼ä½œæˆ

example1 / example2 / example3 ã‚’ä½œæˆã—ã¦ãŠã
![image](https://user-images.githubusercontent.com/13635059/65001338-f0e5f680-d929-11e9-9920-fe08b65bc531.png)

# shoryuken.yml

- AWSã®æ¥ç¶šæƒ…å ±ã‚’æ›¸ãã€‚
- æ‰±ã†ã‚­ãƒ¥ãƒ¼ã®ç¨®é¡ã‚’æ›¸ã„ã¦ãŠãã€‚ã“ã“ã«æ›¸ã„ãŸã‚‚ã®ãŒWorkerã«è‡ªå‹•åæ˜ ã•ã‚Œã‚‹ã¨ã‹ã€ãã†ã„ã†ã“ã¨ã§ã¯ãªã„ã£ã½ã„ï¼Ÿ

```yml
aws:
  access_key_id:      <%= ENV['AWS_ACCESS_KEY_ID'] %>
  secret_access_key:  <%= ENV['AWS_SECRET_ACCESS_KEY'] %>
  region:             <%= ENV['AWS_REGION'] %>
concurrency: 1
queues:
  - example1
  - example2
  - example3

```

# shoryuken_worker.rb

- **rails ã§èµ·å‹•ã™ã‚‹å ´åˆã¯ç„¡è¦–ã•ã‚Œãã†ï¼Ÿ**
- Rails + AcitiveJob ã®å ´åˆã¯ ã‚¸ãƒ§ãƒ–å´ã« perform ã‚’æ›¸ãã€pure ruby ã®å ´åˆã¯ Worker ã« perform ã‚’æ›¸ãã¨ã„ã†ã“ã¨ãªã®ã‹ã‚‚ã—ã‚Œãªã„

[Getting Started Â· phstc/shoryuken Wiki](https://github.com/phstc/shoryuken/wiki/Getting-Started)

# initializers/shoryuken.rb

- ãƒ­ã‚°ã®æ‰±ã„ãªã©ã‚’è¨˜è¼‰ã™ã‚‹ã€‚
- `Rails.logger.level = :debug` ã ã¨ Worker ã§å¤§é‡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ :info ã«ã—ã¦ãŠã„ãŸã€‚
- Shoryukenã§ã¯ Shoryuken å°‚ç”¨ã®  Logger ã‚’åˆ©ç”¨ã—ã¦ãƒ­ã‚®ãƒ³ã‚°ã™ã‚‹ã£ã½ã„ã€‚

```rb
Shoryuken.configure_server do |config|
  # Replace Rails logger so messages are logged wherever Shoryuken is logging
  # Note: this entire block is only run by the processor, so we don't overwrite
  #       the logger when the app is running as usual.

  Rails.logger = Shoryuken::Logging.logger
  Rails.logger.level = :info

  # config.server_middleware do |chain|
  #  chain.add Shoryuken::MyMiddleware
  # end

  # For dynamically adding queues prefixed by Rails.env
  # Shoryuken.add_group('default', 25)
  # %w(queue1 queue2).each do |name|
  #   Shoryuken.add_queue("#{Rails.env}_#{name}", 1, 'default')
  # end
end

# config/initializers/shoryuken.rb
Shoryuken.active_job_queue_name_prefixing = true
```

# config/application.rb

ã‚¢ãƒ€ãƒ—ã‚¿ã«shoryukenã‚’æŒ‡å®šã—ã¦ãŠãã€‚

```rb
require_relative 'boot'

require 'rails/all'

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module RailsActiveJobExample
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 6.0

    # config.active_job.queue_adapter = ENV['QUEUE_ADAPTER'].present? ? ENV['QUEUE_ADAPTER'].to_sym : :sidekiq
    config.active_job.queue_adapter = :shoryuken

    # Settings in config/environments/* take precedence over those specified here.
    # Application configuration can go into files in config/initializers
    # -- all .rb files in that directory are automatically loaded after loading
    # the framework and any gems in your application.
  end
end

```

# make job

rails runner ã‹ä½•ã‹ã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
bundle exec rails runner 'ShoryukenJob.perform_later("ABC")'
```

# æ˜‡ç«œæ‹³ï¼
![image](https://user-images.githubusercontent.com/13635059/65086417-ac6f5f00-d9ec-11e9-841b-75320abd6e46.png)

# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2463








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2019-09-17
