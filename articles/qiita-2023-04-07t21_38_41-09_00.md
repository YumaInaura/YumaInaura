---
title: "AWS  SES  + Ruby / Rails â€“ ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã§ããªã„å ´åˆ ( aws-sdk-rails  / aws-sdk-ses"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Ruby", "Rails", "AWS"]
published: true
---

# çµè«–

- å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã® IAMã« `ses:SendEmail` `ses:SendRawEmail` ã®æ¨©é™ã‚’ä¸ãˆã‚‹
- ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã™ã‚‹

çµè«–ã¨ã—ã¦ã¯ã‚·ãƒ³ãƒ—ãƒ«ã ãŒã€ã“ã®æ‰‹é †ã§è§£æ±ºã—ãŸ

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/89618/a6d89293-b0df-0f19-ff48-24193471ed13.png)

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/89618/77eed46b-a47c-e6ab-b4a9-2cf8a3ea1141.png)

# å•é¡Œ

- ã€ŒSMTPèªè¨¼æƒ…å ±ã®ä½œæˆã€ã§IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»˜ä¸ã•ã‚Œã‚‹æ¨©é™ `AmazonSesSendingAccess` ( `AmazonSesSendingAccess` ) ã§ã¯ä½•æ•…ã‹é€ä¿¡ã§ããªã‹ã£ãŸ
- ã€ŒSMTPèªè¨¼æƒ…å ±ã®ä½œæˆã€ã§ç™ºè¡Œã•ã‚Œã‚‹ã€ŒSMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã€ŒSMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚’åˆ©ç”¨ã—ã¦ã‚‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å‡ºæ¥ãªã‹ã£ãŸ 

ã€ŒSMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã€ŒSMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¯ã„ã‹ã«ã‚‚AWSã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã‚ˆã†ãªæ–‡å­—åˆ—ãªã®ã ãŒåˆ¥ç‰©ã‚‰ã—ã„

# å…¬å¼ã‚¬ã‚¤ãƒ‰ã®æ‰‹é † ( Ruby ã§è©¦ã™ ) 

ApplicationMailer ãªã© Railsçš„ãªã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚‰ãªãã¦ã‚‚ã€
å…¬å¼ã‚¬ã‚¤ãƒ‰ã®æ‰‹é †ã§Rubyã§ã®ãƒ†ã‚¹ãƒˆãŒå‡ºæ¥ã‚‹

Amazon SES E ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
https://docs.aws.amazon.com/ja_jp/sdk-for-ruby/v3/developer-guide/ses-example-send-email.html


è‡ªåˆ†ã®å ´åˆã¯ä¾¿å®œçš„ã«Railsã§ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã—ã¦è©¦ã—ãŸ

gemã«ã¯ `aws-sdk-ses` ã‚’ä½¿ã†

```rb
require 'aws-sdk-ses' # v2: require 'aws-sdk'

sender = 'yuma.inaura@gmail.com'

recipient = 'yuma.inaura@gmail.com'

subject = 'Amazon SES test (AWS SDK for Ruby)'

htmlbody =
  '<h1>Amazon SES test (AWS SDK for Ruby)</h1>' \
  '<p>This email was sent with <a href="https://aws.amazon.com/ses/">' \
  'Amazon SES</a> using the <a href="https://aws.amazon.com/sdk-for-ruby/">' \
  'AWS SDK for Ruby</a>.'

textbody = 'This email was sent with Amazon SES using the AWS SDK for Ruby.'

encoding = 'UTF-8'

credentials = Aws::Credentials.new(
  '*****',
  '*****'
)

ses = Aws::SES::Client.new(
  region: '*****',
  credentials: credentials
)

begin
  ses.send_email(
    destination: {
      to_addresses: [
        recipient
      ]
    },
    message: {
      body: {
        html: {
          charset: encoding,
          data: htmlbody
        },
        text: {
          charset: encoding,
          data: textbody
        }
      },
      subject: {
        charset: encoding,
        data: subject
      }
    },
    source: sender
  )

  puts 'Email sent to ' + recipient

# If something goes wrong, display an error message.
rescue Aws::SES::Errors::ServiceError => e
  puts "Email not sent. Error message: #{e}"
end
```

SMTPãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«æŒ‡å®šã—ãŸå ´åˆã¯ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã„ãŸ

```sh
ruby aws-email.rb

Email not sent. Error message: The request signature we calculated does not match the signature you provided. Check your AWS Secret Access Key and signing method. Consult the service documentation for details.
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã¯HTMLãƒ¡ãƒ¼ãƒ«ãªã®ã§ã€ SendRawEmailã®æ¨©é™ã—ã‹ãªã„å ´åˆã¯
æ¨©é™ãŒãªã„å ´åˆã¯ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãŸ

```sh
ruby aws-email.rb

Email not sent. Error message: User `arn:aws:iam::00000000:user/ses-smtp-user.000000-000000' is not authorized to perform `ses:SendEmail' on resource `arn:aws:ses:**********:0000000000:identity/***********'
```

# Rails

Gem ã¯ aws-sdk-rails ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã
 
`gem 'aws-sdk-rails'`


```rb
require "active_support/core_ext/integer/time"

Rails.application.configure do
  # ä»–ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ–¹æ³•ã¨ã®è¨­å®šã®é•ã„ã¯ã“ã®1è¡Œã ã‘ã«åã¾ã‚‹ ( aws-sdk-rails (3.7.1) )
  config.action_mailer.delivery_method = :ses

  config.action_mailer.default_url_options = { host: 'example.com' }

  config.action_mailer.perform_deliveries = true
  config.action_mailer.perform_caching = false

  # ã‚¨ãƒ©ãƒ¼ã¯æ¤œçŸ¥ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã“ã†
  config.action_mailer.raise_delivery_errors = true
...
```


## ç„¡ç†ã ã£ãŸä¾‹

gemã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ( `aws-sdk-rails (3.7.1)` ) ã®ã›ã„ã‹ã¯åˆ†ã‹ã‚‰ãªã„ãŒ
æ¬¡ã®ã‚ˆã†ã« credeitials ã‚’ã„ã¡ã©ä½œã£ã¦æ¸¡ã™æ–¹å¼ã§ã¯ç„¡ç†ã§ã€ç’°å¢ƒå¤‰æ•°ã‚’åˆ©ç”¨ã—ãªã„ã¨ã†ã¾ããƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ããªã‹ã£ãŸ

```rb
credentials = Aws::Credentials.new(
  ENV.fetch('AWS_ACCESS_KEY_ID', nil),
  ENV.fetch('AWS_SECRET_ACCESS_KEY', nil)
)

Aws::Rails.add_action_mailer_delivery_method(
  :ses,
  credentials:,
  region: 'ap-northeast-1'
)

config.action_mailer.delivery_method = :ses

```


## rails console ã§å®Ÿè¡Œã—ã¦ã¿ã‚‹

```
export AWS_ACCESS_KEY_ID="*******"
export AWS_SECRET_ACCESS_KEY="*********"
export AWS_REGION=**********

rails console
```

ã¦ãã¨ã†ã«ãƒ¡ãƒ¼ãƒ©ãƒ¼ã‚’ä½œã£ã¦ãŠã„ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œ

```
irb(main):001:0> ExampleMailer.new_email.deliver_now
```

# SMTPèªè¨¼æƒ…å ±ã®ä½œæˆ


![image](https://user-images.githubusercontent.com/13635059/230606104-37868ef2-9a4c-405d-a8d0-21d0077ebd9a.png)

SMTPèªè¨¼æƒ…å ±ã®ä½œæˆã‚’ã™ã‚‹ã¨IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã€æ¬¡ã®ã‚ˆã†ã«èªè¨¼æƒ…å ±ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹

```
ses-smtp-user.0000000000-0000000000

SMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼å:
*****************

SMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:
*****************
```

ã ãŒã“ã®ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ã‚‚ãƒ¡ãƒ¼ãƒ«ç™ºè¡Œã¯å‡ºæ¥ãªã‹ã£ãŸ


# ç’°å¢ƒ

- aws-sdk-rails (3.7.1)

# å‚è€ƒ

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã€Amazon SES SMTP ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ä»‹ã—ã¦ E ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹
https://docs.aws.amazon.com/ja_jp/ses/latest/dg/send-email-smtp-client-command-line.html

ã‚³ãƒãƒ³ãƒ‰ã²ã¨ã¤ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹æ–¹ã¯
ç’°å¢ƒå¤‰æ•°ã«AWSã®ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã€ãªãŠã‹ã¤ã€ŒSMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã€ŒSMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¯åˆ©ç”¨ã§ããªã‹ã£ãŸ

```
openssl s_client -crlf -quiet -starttls smtp -connect email-smtp.us-west-2.amazonaws.com:587
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹æ–¹ã‚„ã‚Šæ–¹ã§ã¯
ã“ã®æ–¹æ³•ã§ã¯ã€ŒSMTPèªè¨¼æƒ…å ±ã®ä½œæˆã€ã®ã€ŒSMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã€ŒSMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãŒåˆ©ç”¨ã§ããŸ


```
openssl s_client -crlf -quiet -starttls smtp -connect email-smtp.us-west-2.amazonaws.com:587 < input.txt
```

# æ¤œè¨¼æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã—ã‹ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ããªã„

```
Email address is not verified. The following identities failed the check in region *****
(Aws::SES::Errors::MessageRejected)
```

é€ä¿¡å…ƒã«æ¤œè¨¼æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã—ã‹æŒ‡å®šã§ããªã„ã®ã¯åˆ†ã‹ã‚‹ãŒã€é€ä¿¡å…ˆã«ã‚‚æŒ‡å®šã§ããªã„ã¨ã¯ã©ã†ã„ã†ã“ã¨ã ï¼Ÿ

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/89618/6359097e-ee35-bf34-6ee9-eb20bcdb03e8.png)


ã¨æ€ã£ãŸã‚‰ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã ã¨ãã†ã„ã†å‹•ä½œã«ãªã‚‹ã‚ˆã†ã 

AmazonSESã§ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã—ã‹ãƒ¡ãƒ¼ãƒ«ãŒé€ã‚Œãªã„ç†ç”±
https://blog.framinal.life/entry/2018/08/24/094009

Amazon SES ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¤–ã¸ã®ç§»å‹•

>E ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å…ˆã¯ã€æ¤œè¨¼æ¸ˆã¿ E ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŠã‚ˆã³ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã¾ãŸã¯ Amazon SES ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
https://docs.aws.amazon.com/ja_jp/ses/latest/dg/request-production-access.html

# ECSã§ã¯

Railsã«Webã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹å ´åˆã€
ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒãƒªã‚·ãƒ¼ ( `ses:SendEmail` `ses:SendRawEmail` )ã‚’ã¤ã‘ã‚Œã°è‰¯ã„ã‚ˆã†ã 
(ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã§ã¯ãªã)

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura

