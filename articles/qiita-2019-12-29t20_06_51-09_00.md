---
title: #Stripe API + Ruby ã§ ã‚µãƒ–ã‚¹ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼å®šæœŸæ”¯æ‰•ã„ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ã‚’ã—ã¦ãƒ•ã‚§ãƒ¼ã‚ºãƒ»ãƒ—ãƒ©ãƒ³æ›´æ–°ã™ã‚‹ä¾‹
emoji: "ğŸ–¥"
type: "idea"
topics: ["stripe"]
published: true
---

- ãƒ•ã‚§ãƒ¼ã‚ºã®ä¸­èº«ã‚’ä¸¸ã”ã¨æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸€éƒ¨æ›´æ–°ã®ã‚ˆã†ãªã“ã¨ã¯å‡ºæ¥ãªã•ãã†ï¼Ÿ ä¸€å€‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æœŸé–“ãŒå¤‰ã‚ã‚Œã°ä»–ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æœŸé–“ã‚‚å¿…ç„¶çš„ã«å¤‰ã‚ã‚‹ãŸã‚ã€è‡ªå‹•çš„ã«æœŸé–“ã‚’ãšã‚‰ã™ã‚ˆã†ãªã“ã¨ã¯ã—ã¦ãã‚Œãªã„ã¨ã„ã“ã¨ã ã‚ã†ã‹ã€‚ã¡ãªã¿ã«Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã ã¨ãƒ•ã‚§ãƒ¼ã‚ºå˜ä½ã§ã®èª¿æ•´ãŒã§ãã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚
- æ›´æ–°ã®æ™‚ã® start_date ã¯ä½œæˆæ™‚ã¨ã¯é•ã„ã€SubscriptionSchedule æœ¬ä½“ã§ã¯ãªãã€ãƒ•ã‚§ãƒ¼ã‚ºã®ä¸€å€‹ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã ã€‚
- æ—¢ã« SubscriptionSchedule ã¯é¡§å®¢ã«ç´ã¥ã„ã¦ã„ã‚‹ãŸã‚ã€é¡§å®¢idã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ãªã„ã€‚

Stripe API Reference - Update a schedule
https://stripe.com/docs/api/subscription_schedules/update
   
```rb
# Code

require 'stripe'

Stripe::api_key = ENV['STRIPE_SECRET_KEY']

product1 = Stripe::Product.create(name: "Gold plan #{rand(9999999999)}")
plan1 = Stripe::Plan.create(interval: 'month', currency: 'jpy', amount: 5000, product: product1.id, usage_type: 'licensed')

product2 = Stripe::Product.create(name: "Silver plan #{rand(9999999999)}")
plan2 = Stripe::Plan.create(interval: 'month', currency: 'jpy', amount: 3000, product: product2.id, usage_type: 'licensed')

product3 = Stripe::Product.create(name: "Bronse plan #{rand(9999999999)}")
plan3 = Stripe::Plan.create(interval: 'month', currency: 'jpy', amount: 1000, product: product3.id, usage_type: 'licensed')

tax_rate = Stripe::TaxRate.create(display_name: 'Tax Rate', percentage: 10.0, inclusive: false)
customer = Stripe::Customer.create
payment_method = Stripe::PaymentMethod.create(type: 'card', card: { number: '4242424242424242', exp_year: 2030, exp_month: 01})
customer_payment_method = Stripe::PaymentMethod.attach(payment_method.id, customer: customer.id)

# https://stripe.com/docs/api/subscription_schedules/create
subscription_schedule = Stripe::SubscriptionSchedule.create(
  {
    customer: customer.id,
    start_date: Time.now.to_i + 60*60,
    phases: [
      {
        plans:
          [
            { plan: plan1.id, quantity: 1 },
          ],
          default_payment_method: customer_payment_method.id,
          default_tax_rates: [tax_rate],
          iterations: 1,
      },
      {
        plans:
          [
            { plan: plan2.id, quantity: 1 },
          ],
          default_payment_method: customer_payment_method.id,
          default_tax_rates: [tax_rate],
          iterations: 2,
      }
    ],
  }
)

puts '-' * 100
puts "Subscription Schedule created"
puts "https://dashboard.stripe.com/test/subscription_schedules/#{subscription_schedule.id}"
puts '-' * 100
puts subscription_schedule

# https://stripe.com/docs/api/subscription_schedules/update
# no customer id because already knows customer
# no start_date because already set start_date when created
#
# If no phases has start_date
# Stripe::InvalidRequestError: The subscription schedule update is missing at least one phase with a `start_date` to anchor end dates to.

# REMOVE plan1
# ADD again plan 2
# ADD new plan3
updated_subscription_schedule = Stripe::SubscriptionSchedule.update(
  subscription_schedule.id,
  {
    phases: [
      {
        plans:
          [
            { plan: plan2.id, quantity: 1 },
          ],
          default_payment_method: customer_payment_method.id,
          default_tax_rates: [tax_rate],
          iterations: 3,
          start_date: Time.now.to_i + 60*60,
      },
      {
        plans:
          [
            { plan: plan3.id, quantity: 1 },
          ],
          default_payment_method: customer_payment_method.id,
          default_tax_rates: [tax_rate],
          iterations: 4,
      }
    ]
  }
)

puts '-' * 100
puts "Subscription Schedule updated"
puts "https://dashboard.stripe.com/test/subscription_schedules/#{updated_subscription_schedule.id}"
puts '-' * 100
puts updated_subscription_schedule

```


```
----------------------------------------------------------------------------------------------------
Subscription Schedule created
https://dashboard.stripe.com/test/subscription_schedules/sub_sched_1Fuc1DCmti5jpytUKi62lAzm
----------------------------------------------------------------------------------------------------
{
  "id": "sub_sched_1Fuc1DCmti5jpytUKi62lAzm",
  "object": "subscription_schedule",
  "canceled_at": null,
  "completed_at": null,
  "created": 1577526935,
  "current_phase": null,
  "customer": "cus_GRV15kbeph5URv",
  "default_settings": {
    "billing_thresholds": null,
    "collection_method": "charge_automatically",
    "default_payment_method": null,
    "default_source": null,
    "invoice_settings": null
  },
  "end_behavior": "release",
  "livemode": false,
  "metadata": {
  },
  "phases": [
    {
      "application_fee_percent": null,
      "billing_thresholds": null,
      "collection_method": null,
      "coupon": null,
      "default_payment_method": "pm_1Fuc1CCmti5jpytUVOXozqqT",
      "default_tax_rates": [
        {
          "id": "txr_1Fuc1BCmti5jpytUJhjPKOkr",
          "object": "tax_rate",
          "active": true,
          "created": 1577526933,
          "description": null,
          "display_name": "Tax Rate",
          "inclusive": false,
          "jurisdiction": null,
          "livemode": false,
          "metadata": {
          },
          "percentage": 10.0
        }
      ],
      "end_date": 1580208934,
      "invoice_settings": null,
      "plans": [
        {
          "billing_thresholds": null,
          "plan": "plan_GRV1VgD9k7xx7K",
          "quantity": 1,
          "tax_rates": [

          ]
        }
      ],
      "prorate": true,
      "start_date": 1577530534,
      "tax_percent": 10.0,
      "trial_end": null
    },
    {
      "application_fee_percent": null,
      "billing_thresholds": null,
      "collection_method": null,
      "coupon": null,
      "default_payment_method": "pm_1Fuc1CCmti5jpytUVOXozqqT",
      "default_tax_rates": [
        {
          "id": "txr_1Fuc1BCmti5jpytUJhjPKOkr",
          "object": "tax_rate",
          "active": true,
          "created": 1577526933,
          "description": null,
          "display_name": "Tax Rate",
          "inclusive": false,
          "jurisdiction": null,
          "livemode": false,
          "metadata": {
          },
          "percentage": 10.0
        }
      ],
      "end_date": 1585392934,
      "invoice_settings": null,
      "plans": [
        {
          "billing_thresholds": null,
          "plan": "plan_GRV1MyHhrpvp0e",
          "quantity": 1,
          "tax_rates": [

          ]
        }
      ],
      "prorate": true,
      "start_date": 1580208934,
      "tax_percent": 10.0,
      "trial_end": null
    }
  ],
  "released_at": null,
  "released_subscription": null,
  "renewal_interval": null,
  "revision": "sub_sched_rev_1Fuc1DCmti5jpytU3JXMhiLq",
  "status": "not_started",
  "subscription": null
}
----------------------------------------------------------------------------------------------------
Subscription Schedule updated
https://dashboard.stripe.com/test/subscription_schedules/sub_sched_1Fuc1DCmti5jpytUKi62lAzm
----------------------------------------------------------------------------------------------------
{
  "id": "sub_sched_1Fuc1DCmti5jpytUKi62lAzm",
  "object": "subscription_schedule",
  "canceled_at": null,
  "completed_at": null,
  "created": 1577526935,
  "current_phase": null,
  "customer": "cus_GRV15kbeph5URv",
  "default_settings": {
    "billing_thresholds": null,
    "collection_method": "charge_automatically",
    "default_payment_method": null,
    "default_source": null,
    "invoice_settings": {
      "days_until_due": null
    }
  },
  "end_behavior": "release",
  "livemode": false,
  "metadata": {
  },
  "phases": [
    {
      "application_fee_percent": null,
      "billing_thresholds": null,
      "collection_method": null,
      "coupon": null,
      "default_payment_method": "pm_1Fuc1CCmti5jpytUVOXozqqT",
      "default_tax_rates": [
        {
          "id": "txr_1Fuc1BCmti5jpytUJhjPKOkr",
          "object": "tax_rate",
          "active": true,
          "created": 1577526933,
          "description": null,
          "display_name": "Tax Rate",
          "inclusive": false,
          "jurisdiction": null,
          "livemode": false,
          "metadata": {
          },
          "percentage": 10.0
        }
      ],
      "end_date": 1585392935,
      "invoice_settings": null,
      "plans": [
        {
          "billing_thresholds": null,
          "plan": "plan_GRV1MyHhrpvp0e",
          "quantity": 1,
          "tax_rates": [

          ]
        }
      ],
      "prorate": true,
      "start_date": 1577530535,
      "tax_percent": 10.0,
      "trial_end": null
    },
    {
      "application_fee_percent": null,
      "billing_thresholds": null,
      "collection_method": null,
      "coupon": null,
      "default_payment_method": "pm_1Fuc1CCmti5jpytUVOXozqqT",
      "default_tax_rates": [
        {
          "id": "txr_1Fuc1BCmti5jpytUJhjPKOkr",
          "object": "tax_rate",
          "active": true,
          "created": 1577526933,
          "description": null,
          "display_name": "Tax Rate",
          "inclusive": false,
          "jurisdiction": null,
          "livemode": false,
          "metadata": {
          },
          "percentage": 10.0
        }
      ],
      "end_date": 1595933735,
      "invoice_settings": null,
      "plans": [
        {
          "billing_thresholds": null,
          "plan": "plan_GRV1rFG3m02W73",
          "quantity": 1,
          "tax_rates": [

          ]
        }
      ],
      "prorate": true,
      "start_date": 1585392935,
      "tax_percent": 10.0,
      "trial_end": null
    }
  ],
  "released_at": null,
  "released_subscription": null,
  "renewal_interval": null,
  "revision": "sub_sched_rev_1Fuc1DCmti5jpytU1FOdmZZ8",
  "status": "not_started",
  "subscription": null
}
```

![image](https://user-images.githubusercontent.com/13635059/71541982-f2e93800-29a3-11ea-8892-219536d17713.png)


# å‚è€ƒ

æ—¥æœ¬æ­£å¼ãƒªãƒªãƒ¼ã‚¹ã—ãŸStripeã‚’ä½¿ã£ã¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹ - Qiita
https://qiita.com/tady/items/7617e62b2a5402ebd0fb

Stripe Billing 101 - Qiita
https://qiita.com/y_toku/items/235b5e7ee00792edcbbf

Stripeåˆå¿ƒè€…ã®ãŸã‚ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆRailsç·¨ï¼‰ - Qiita
https://qiita.com/ryouzi/items/6ee8f277471aa3b02f7b

# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2890








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->


