---
title: "#Ruby ã® Faraday ã§ ssh + SOCKS  ã«ã‚ˆã‚‹ https proxy æ¥ç¶šãŒã§ããªã‹ã£ãŸã®ã§ faraday_ada"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Ruby"]
published: true
published_at: 2019-11-03
---

# SOCKS ã‚’èµ·å‹•

```
ssh -vND 8888  user@host
```

# gem install

```
gem install faraday
gem install faraday_adapter_socks
```

# Ruby or pry

ç’°å¢ƒå¤‰æ•°ã« socks ã®URLã‚’æŒ‡å®šã™ã‚‹

```
https_proxy=socks://127.0.0.1:8888 ruby some.rb
```

```
https_proxy=socks://127.0.0.1:8888 pry
```

# Ruby Code

adapter ã‚’æŒ‡å®šã—ã¦ get ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã‚‹

```rb
Faraday.new(url: 'https://httpbin.org/ip') { |conn| conn.adapter :net_http_socks }.get.body
```

e.g result 

IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹
sshã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã£ã¦ããŸã‚‰æˆåŠŸ

```
[8] pry(main)> Faraday.new(url: 'https://httpbin.org/ip') { |conn| conn.adapter :net_http_socks }.get.body
=> "{\n  \"origin\": \"YYY.YYY.YYY.YYY, YYY.YYY.YYY.YYY\"\n}\n"
```

# ã‚¢ãƒ€ãƒ—ã‚¿ã‚’æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆ

ã“ã‚“ãªã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã£ã¦ã„ãŸ

```
[10] pry(main)> Faraday.new(url: 'https://httpbin.org/ip').get.body
Faraday::ConnectionFailed: end of file reached
from /usr/local/lib/ruby/2.5.0/net/protocol.rb:189:in `rbuf_fill'
Caused by EOFError: end of file reached
from /usr/local/lib/ruby/2.5.0/net/protocol.rb:189:in `rbuf_fill'
```



# Grete gem "faraday_adapter_socks" !

thank you 

https://github.com/goldeneggg/faraday_adapter_socks/blob/master/lib/faraday/adapter/net_http_socks.rb

```rb
module Faraday
  class Adapter < Middleware

    register_middleware net_http_socks: :NetHttpSocks

    class NetHttpSocks < Faraday::Adapter::NetHttp

      SOCKS_SCHEMES = ['socks', 'socks4', 'socks5']

      def net_http_connection(env)
        proxy = env[:request][:proxy]

        net_http_class = if proxy
          if SOCKS_SCHEMES.include?(proxy[:uri].scheme)
            Net::HTTP::SOCKSProxy(proxy[:uri].host, proxy[:uri].port)
          else
            Net::HTTP::Proxy(proxy[:uri].host, proxy[:uri].port, proxy[:user], proxy[:password])
          end
        else
          Net::HTTP
        end

        net_http_class.new(env[:url].host, env[:url].port)
      end
    end
  end
end
```


# MiddleWare Image

![image](https://user-images.githubusercontent.com/13635059/68077691-9f2afa00-fe0b-11e9-9058-2b80c7b1f4f0.png)

https://lostisland.github.io/faraday/middleware/


# Original by Github issue

https://github.com/YumaInaura/YumaInaura/issues/2660








<!-- Update From Qiita API -->

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ





# Twitter


https://twitter.com/YumaInaura


<!-- Update From Qiita API -->



# å…¬é–‹æ—¥æ™‚

2019-11-03
