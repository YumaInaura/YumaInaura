---
title: "AWS ECS â€“ CodePipeline + CodeDeploy ã§ã® appspec / taskdef é–¢ä¿‚ã®ã‚¨ãƒ©ãƒ¼"
emoji: "ğŸ–¥"
type: "tech"
topics: ["AWS", "ECS", "CodeDeploy"]
published: true
published_at: 2023-08-17t17:18
---

CODE DEPLOY ã§ appspec ã‚’ã†ã¾ãæ›¸ã‘ãšã«è©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ãŸã€‚

# è¨­å®š

CodePiplineã®Deployã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®šã§ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ AWS ECS(ãƒ–ãƒ«ãƒ¼/ã‚°ãƒªãƒ¼ãƒ³)ã«ã—ã¦ã„ã‚‹å‰æ

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/d2185955-5676-44ab-ad5b-7534694cd10f)

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/824b17c4-59c5-4f9a-abd1-d03255ab369d)


# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼

CodeBuildã®ã€Œãƒ‡ãƒ—ãƒ­ã‚¤IDã€ã®ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã€‚ã“ã‚“ãªã‚„ã¤ã€‚

<img width="1083" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/d9d07e74-8f10-46be-919b-2aa119853485">

## appspecãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„

> An AppSpec file is required, but could not be found in the revision

ãƒ¬ãƒã‚¸ãƒˆãƒªã®ãƒˆãƒƒãƒ—ã« appspec.yml ã‚’ç½®ã„ã¦ã‚ã‚‹ã®ã«ãªã„ã¨è¨€ã‚ã‚Œã‚‹

### è§£æ±º

buildspec.yml ã® artifacts ã« appspecãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã¨è§£æ±ºã—ãŸ

```yml
artifacts:
  files:
    - appspec.yml
```

ã€ŒDeploy ã‚¹ãƒ†ãƒ¼ã‚¸ã® å…¥åŠ›ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ Build ã«ã—ã¦ã„ã‚‹å ´åˆã¯
 Deployã‚¹ãƒ†ãƒ¼ã‚¸ã§ åˆ©ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ artifacts ã§æŒ‡å®šã—ã¦ãŠã‹ãªã‘ã‚Œã°ã„ã‘ãªã„ã€ã¨ç†è§£ã—ãŸ (ãŸã¶ã‚“)


## è¨­å®šå€¤ã®ã‚¨ãƒ©ãƒ¼ï¼Ÿ (ã§ã¯ãªã‹ã£ãŸ)

> The deployment failed because the AppSpec file that specifies the deployment configuration is missing or has an invalid configuration.
> Could not parse or validate one of the resources in the app-spec.

æœ€å°é™ã®é …ç›®ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¯ãšãŒã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã€‚

```yml
version: 0.0
Resources:
  - TargetService:
      Type: AWS::ECS::Service
      Properties:
        TaskDefinition: <TASK_DEFINITION>
        LoadBalancerInfo:
          ContainerName: "container-name"
          ContainerPort: 8080
```

TASK_DEFINITION ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®å•é¡Œã§ã¯ãªã•ãã†ã€‚
ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤IDã®ãƒšãƒ¼ã‚¸ã§
***ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®è©³ç´° > ã‚¢ãƒ—ãƒªã®ä»•æ§˜*** ã‚’è¦‹ã‚‹ã¨ `<TASK_DEFINITION>` ãŒæ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã®ARNã«å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã£ãŸã€‚

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/1d063706-839b-443e-ae4e-58f7863f485e)



å¾Œè¿°ã™ã‚‹ãŒYAMLã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚„å¿…é ˆé …ç›®ä¸è¶³ã§ã‚‚ãªã•ãã†ã€‚
(ãã®å ´åˆã¯ãã‚Œãã‚Œåˆ¥ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§)

### è§£æ±º

ECSå´ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚’CODE BUILDçµŒç”± ã§ã¯ãªã ECSã¸ã®ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤(ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ)ã«ã—ã¦ã—ã¾ã£ã¦ã„ãŸã€‚
ä½œæ¥­é€”ä¸­ã§çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ãŸã¾ã¾å¿˜ã‚Œã¦ã„ãŸã‚ˆã†ã ã€‚

ã“ã“ã§ã‹ãªã‚Šãƒãƒã£ãŸãŒã‚ˆã†ã‚„ãblue/greenãƒ‡ãƒ—ãƒ­ã‚¤ãŒèµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/90a62817-dbce-4ff7-b823-cc7f6f758f9f)


## YAMLæ§‹æ–‡ã®ã‚¨ãƒ©ãƒ¼


> The deployment failed because the AppSpec file that specifies the deployment configuration is missing or has an invalid configuration.
>  Failed to parse your appspec file. Please validate your appspec format and try again later.

YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ãŸã¨ã“ã‚ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç”Ÿã˜ãŸ

```yaml
XXX: YYY:
````


## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãƒ‘ãƒ¼ã‚¹ã§ããªã„

>  The deployment failed because the AppSpec file that specifies the deployment configuration is missing or has an invalid configuration. 
> The input AppSpec file is a not well-formed yaml. The template cannot be parsed.

é …ç›®ã®è¶³ã‚Šãªã„YAMLã‚’è©¦ã—ã¦ã¿ãŸã¨ã“ã‚ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç”Ÿã˜ãŸã€‚

```yaml
version: 0.0
Resources:
  - TargetService:
      Type: AWS::ECS::Service
```

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œå‰ã®ã‚¨ãƒ©ãƒ¼

CodePipelineã®Deployã‚¹ãƒ†ãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼

ãã‚‚ãã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³
taskdef.json / appspec.yaml ã®è¨˜è¿°ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãªã©ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãŸã‚ˆã†ã 


ã“ã‚“ãªã‚„ã¤

<img width="492" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/115efcbf-ad6e-4e5f-9f23-b20694c20051">

## ä¾‹1

> Exception while trying to read the AppSec artifact file from: Build.

å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ appspec ã¨ã—ã¦æŒ‡å®šã—ãŸæ™‚ã«ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/11d0efb1-a7c5-4a76-91c3-dc134c4fc829)

## ä¾‹

> Tags can not be empty.

taskdef.json ã®ã‚¿ã‚°æŒ‡å®šã‚’ç©ºã§æ›¸ã„ã¦ã„ãŸã‚‰

```
"tags": []
```

## ä¾‹

è©¦ã—ã« taskdef.json ã‚’å¤‰ãˆã¦ã¿ã‚‹ã¨

```
"tags": ["XXX"]
```

> Expected null

ä½•â€¦ï¼Ÿ

![image](https://github.com/YumaInaura/YumaInaura/assets/13635059/1e04a72d-5521-4209-a295-799772fa9a50)


ãã‚‚ãã‚‚tagsã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¶ˆã—ã¦ã—ã¾ã†ã“ã¨ã§å¯¾å¿œã—ãŸ

## ä¾‹

taskdef.json ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’è§£é‡ˆã—ã¦ãã‚Œãªã„

> Container.image contains invalid characters.

```json
    "containerDefinitions": [
      {
        "image": "<IMAGE1_NAME>",
```

ã„ã£ãŸã‚“ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ã‚„ã‚ã¦ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç›´æ¥æŒ‡å®šã™ã‚‹ã“ã¨ã§å¯¾å¿œã—ãŸ 

```json
    "containerDefinitions": [
        {
            "image": "**********.dkr.ecr.***********.amazonaws.com/**********:***",
```

ã ãŒã“ã‚Œã‚‚ä¸Šã«æ›¸ã„ãŸã®ã¨åŒã˜ã§ECSã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚’é–“é•ãˆã¦ã„ãŸã›ã„ã ã£ãŸã‹ã‚‚ã—ã‚Œãªã„
(ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´å¾Œã¯ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚‰ãªããªã£ãŸ)

## ä¾‹

ä»¥å‰ã« terraform apply ã§ ECSã‚µãƒ¼ãƒ“ã‚¹ã«ç´ã¥ãã‚¿ã‚¹ã‚¯å®šç¾©ã‚’æ›´æ–°ã—ã‚ˆã†ã¨ã—ãŸæ™‚ã«ã“ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸãŒ CodeDeploy ã§ã®å®Ÿè¡Œæ™‚ã«ã‚‚åŒã˜ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã€‚

>  Unable to update task definition on services with a CODE_DEPLOY deployment controller. Use AWS CodeDeploy to trigger a new deployment. 




# NOTE

- Codepipeline ã®ãƒˆãƒ©ã‚¤&ã‚¨ãƒ©ãƒ¼ã¯1å›ã‚ãŸã‚Šæ™®é€šã§10åˆ†ã¨ã‹ã‹ã‹ã‚‹ã€‚é€”ä¸­ã‹ã‚‰ build ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯è»½é‡ãª docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚ˆã†ã«å·®ã—æ›¿ãˆã¦è©¦ã—ãŸã€‚ ( ã¦ãã¨ã†ã« alpine ã§ )

å¾Œã‹ã‚‰æ°—ã¥ã„ãŸãŒCodePipelineã‚’é€šã•ãšã«CodeBuildå˜ä½“ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã§ãã‚‹ãƒ¢ãƒ¼ãƒ‰ã‚‚ã‚ã‚‹ã‚ˆã†ãªã®ã§ã“ã‚Œã‚’æ´»ç”¨ã«ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚çŸ¥ã‚Œãªã„ã€‚ appspec ã‚‚ç›´æ¥ã‚¨ãƒ‡ã‚£ã‚¿ã§ã‚³ãƒ¼ãƒ‰å†…å®¹ã‚’æŒ‡å®šã§ãã‚‹ã¿ãŸã„ã ã€‚

<img width="1073" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/9741c914-e062-4aec-8247-724d9405aaad">


# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura


# å…¬é–‹æ—¥æ™‚

2023-08-17
